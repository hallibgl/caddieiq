<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Caddie IQ â€” Golf Performance Coach</title>

<!-- Supabase JS client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap');

  :root {
    --green: #2d6a4f;
    --green-light: #52b788;
    --green-pale: #d8f3dc;
    --fairway: #1b4332;
    --gold: #f4a261;
    --gold-light: #ffd166;
    --cream: #faf7f0;
    --ink: #1a1a2e;
    --mid: #4a4a6a;
    --muted: #9090aa;
    --danger: #e63946;
    --card: #ffffff;
    --border: #e8e4da;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--cream); color: var(--ink); min-height: 100vh; }

  /* â”€â”€ AUTH SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #auth-screen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--fairway);
    padding: 1.5rem;
  }

  .auth-box {
    background: white;
    border-radius: 16px;
    padding: 2.5rem;
    width: 100%;
    max-width: 420px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }

  .auth-logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2.4rem;
    color: var(--fairway);
    letter-spacing: 3px;
    text-align: center;
    margin-bottom: 0.25rem;
  }

  .auth-logo span { color: var(--green-light); }
  .auth-tagline { text-align: center; color: var(--muted); font-size: 0.85rem; margin-bottom: 2rem; }

  .auth-tabs { display: flex; background: var(--cream); border-radius: 8px; padding: 4px; margin-bottom: 1.75rem; }
  .auth-tab {
    flex: 1; padding: 0.6rem; text-align: center; border: none;
    background: none; border-radius: 6px; cursor: pointer;
    font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: 0.88rem;
    color: var(--muted); transition: all 0.2s;
  }
  .auth-tab.active { background: white; color: var(--fairway); box-shadow: 0 1px 6px rgba(0,0,0,0.1); }

  .auth-form { display: flex; flex-direction: column; gap: 0.75rem; }
  .auth-form input {
    width: 100%; padding: 0.75rem 1rem;
    border: 1.5px solid var(--border); border-radius: 8px;
    font-family: 'DM Sans', sans-serif; font-size: 0.9rem;
    transition: border-color 0.2s;
  }
  .auth-form input:focus { outline: none; border-color: var(--green-light); }

  .auth-btn {
    width: 100%; padding: 0.85rem;
    background: var(--fairway); color: white; border: none;
    border-radius: 8px; font-family: 'DM Sans', sans-serif;
    font-size: 0.95rem; font-weight: 600; cursor: pointer;
    transition: all 0.2s; margin-top: 0.5rem;
  }
  .auth-btn:hover { background: var(--green); }
  .auth-btn:disabled { background: var(--muted); cursor: not-allowed; }

  .auth-error {
    background: #ffeaec; border: 1px solid #ffb3ba; color: var(--danger);
    border-radius: 8px; padding: 0.75rem 1rem; font-size: 0.83rem; display: none;
  }
  .auth-success {
    background: var(--green-pale); border: 1px solid #95d5b2; color: var(--green);
    border-radius: 8px; padding: 0.75rem 1rem; font-size: 0.83rem; display: none;
  }

  /* â”€â”€ PROFILE SETUP SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #profile-setup-screen {
    min-height: 100vh; display: none; align-items: center;
    justify-content: center; background: var(--fairway); padding: 1.5rem;
  }
  .setup-box {
    background: white; border-radius: 16px; padding: 2.5rem;
    width: 100%; max-width: 480px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    max-height: 90vh; overflow-y: auto;
  }
  .setup-step {
    display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem;
    color: var(--muted); margin-bottom: 1.5rem; font-family: 'DM Mono', monospace;
  }
  .setup-step-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green-light); }
  .avatar-grid { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1rem; }
  .avatar-swatch {
    width: 38px; height: 38px; border-radius: 50%; cursor: pointer;
    border: 3px solid transparent; transition: all 0.2s;
  }
  .avatar-swatch:hover { transform: scale(1.15); }
  .avatar-swatch.selected { border-color: var(--ink); transform: scale(1.15); }
  .avatar-preview {
    width: 70px; height: 70px; border-radius: 50%; display: flex;
    align-items: center; justify-content: center; font-family: 'Bebas Neue', sans-serif;
    font-size: 1.8rem; color: white; margin: 0 auto 1.5rem; transition: background 0.3s;
  }
  .user-avatar {
    width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center;
    justify-content: center; font-family: 'Bebas Neue', sans-serif; font-size: 0.9rem;
    color: white; cursor: pointer; flex-shrink: 0; border: 2px solid rgba(255,255,255,0.2);
  }
  .profile-info-card {
    background: var(--fairway); border-radius: 12px; padding: 2rem;
    display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem; color: white;
  }
  .profile-big-avatar {
    width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center;
    justify-content: center; font-family: 'Bebas Neue', sans-serif; font-size: 2.2rem;
    color: white; flex-shrink: 0;
  }
  .profile-info-name { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; letter-spacing: 1px; color: var(--gold-light); }
  .profile-info-meta { font-size: 0.83rem; color: rgba(255,255,255,0.65); margin-top: 0.3rem; line-height: 1.7; }
  .profile-info-username { font-size: 0.82rem; color: var(--green-light); font-family: 'DM Mono', monospace; }



  /* â”€â”€ APP SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #app-shell { display: none; }

  header {
    background: var(--fairway); padding: 0 2rem;
    display: flex; align-items: center; justify-content: space-between;
    height: 64px; position: sticky; top: 0; z-index: 100;
    box-shadow: 0 2px 20px rgba(0,0,0,0.3);
  }

  .logo { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; color: var(--gold-light); letter-spacing: 2px; }
  .logo span { color: var(--green-light); }

  nav { display: flex; gap: 0.25rem; flex-wrap: wrap; }
  nav button {
    background: none; border: none; color: rgba(255,255,255,0.6);
    font-family: 'DM Sans', sans-serif; font-size: 0.82rem; font-weight: 500;
    padding: 0.5rem 0.85rem; border-radius: 6px; cursor: pointer; transition: all 0.2s;
  }
  nav button:hover { background: rgba(255,255,255,0.1); color: white; }
  nav button.active { background: var(--green); color: var(--gold-light); }

  .header-user {
    display: flex; align-items: center; gap: 0.75rem;
    font-size: 0.8rem; color: rgba(255,255,255,0.6);
  }

  .signout-btn {
    background: rgba(255,255,255,0.1); border: none; color: rgba(255,255,255,0.7);
    padding: 0.35rem 0.75rem; border-radius: 6px; cursor: pointer;
    font-size: 0.78rem; font-family: 'DM Sans', sans-serif; transition: all 0.2s;
  }
  .signout-btn:hover { background: rgba(255,255,255,0.2); color: white; }

  main { max-width: 1100px; margin: 0 auto; padding: 2rem 1.5rem; }

  /* â”€â”€ PANELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .panel { display: none; animation: fadeIn 0.3s ease; }
  .panel.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

  .section-title { font-family: 'Bebas Neue', sans-serif; font-size: 2.2rem; color: var(--fairway); letter-spacing: 1px; margin-bottom: 0.25rem; }
  .section-sub { color: var(--muted); font-size: 0.9rem; margin-bottom: 2rem; }

  /* â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
  .card-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 1px; color: var(--green); margin-bottom: 1rem; }

  /* â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
  .stat-box { background: white; border: 1px solid var(--border); border-radius: 10px; padding: 1rem; text-align: center; }
  .stat-box .sb-val { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; color: var(--fairway); line-height: 1; }
  .stat-box .sb-label { font-size: 0.72rem; color: var(--muted); margin-top: 0.3rem; text-transform: uppercase; letter-spacing: 0.5px; }

  /* â”€â”€ FORM ELEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--mid); margin-bottom: 0.4rem; letter-spacing: 0.3px; }
  input[type="number"], input[type="text"], select, textarea {
    width: 100%; padding: 0.65rem 0.85rem;
    border: 1.5px solid var(--border); border-radius: 8px;
    font-family: 'DM Mono', monospace; font-size: 0.88rem; color: var(--ink);
    background: white; transition: border-color 0.2s; margin-bottom: 1rem;
  }
  input:focus, select:focus, textarea:focus { outline: none; border-color: var(--green-light); }

  /* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; border-radius: 8px; border: none; font-family: 'DM Sans', sans-serif; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
  .btn-primary { background: var(--green); color: white; }
  .btn-primary:hover { background: var(--fairway); transform: translateY(-1px); }
  .btn-primary:disabled { background: var(--muted); cursor: not-allowed; transform: none; }
  .btn-outline { background: white; color: var(--green); border: 2px solid var(--green); }
  .btn-outline:hover { background: var(--green-pale); }

  /* â”€â”€ AI RESPONSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .ai-response { background: var(--fairway); border-radius: 12px; padding: 1.75rem; color: white; display: none; position: relative; overflow: hidden; }
  .ai-response::before { content: 'â›³'; position: absolute; right: 1.5rem; top: 1.5rem; font-size: 2rem; opacity: 0.15; }
  .ai-response.visible { display: block; animation: fadeIn 0.4s ease; }
  .ai-label { font-family: 'DM Mono', monospace; font-size: 0.72rem; color: var(--gold-light); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
  .ai-label::before { content: ''; width: 8px; height: 8px; border-radius: 50%; background: var(--green-light); animation: pulse 1.5s infinite; display: inline-block; }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
  .ai-body { font-size: 0.92rem; line-height: 1.75; color: rgba(255,255,255,0.9); white-space: pre-wrap; }
  .ai-body strong { color: var(--gold-light); font-weight: 600; }

  /* â”€â”€ LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .loading { display: flex; align-items: center; gap: 0.75rem; color: var(--green-light); font-size: 0.88rem; }
  .spinner { width: 18px; height: 18px; border: 2px solid rgba(82,183,136,0.3); border-top-color: var(--green-light); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€ UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .upload-zone { border: 2px dashed var(--border); border-radius: 12px; padding: 3rem 2rem; text-align: center; cursor: pointer; transition: all 0.2s; background: white; }
  .upload-zone:hover, .upload-zone.dragover { border-color: var(--green-light); background: var(--green-pale); }
  .upload-icon { font-size: 2.5rem; margin-bottom: 1rem; }
  .upload-zone h3 { font-size: 1.1rem; color: var(--fairway); margin-bottom: 0.5rem; }
  .upload-zone p { font-size: 0.85rem; color: var(--muted); }
  #file-input { display: none; }
  .data-table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 0.82rem; font-family: 'DM Mono', monospace; }
  th { background: var(--fairway); color: var(--green-light); padding: 0.6rem 0.75rem; text-align: left; font-size: 0.72rem; letter-spacing: 0.5px; white-space: nowrap; }
  td { padding: 0.55rem 0.75rem; border-bottom: 1px solid var(--border); color: var(--ink); white-space: nowrap; }
  tr:hover td { background: var(--green-pale); }

  /* â”€â”€ ANALYZER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .analyzer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
  @media (max-width: 700px) { .analyzer-grid { grid-template-columns: 1fr; } nav { display: none; } }
  .divider { border: none; border-top: 1px solid var(--border); margin: 1.5rem 0; }

  /* â”€â”€ SHOT VIZ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .shot-viz { background: #0a2e1a; border-radius: 12px; padding: 1.5rem; position: relative; overflow: hidden; min-height: 160px; display: flex; align-items: center; justify-content: center; }

  /* â”€â”€ ROADMAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .handicap-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
  .hc-card { border: 2px solid var(--border); border-radius: 10px; padding: 1.25rem; cursor: pointer; transition: all 0.2s; text-align: center; }
  .hc-card:hover { border-color: var(--green-light); transform: translateY(-2px); }
  .hc-card.selected { border-color: var(--green); background: var(--green-pale); }
  .hc-card .hc-range { font-family: 'Bebas Neue', sans-serif; font-size: 1.6rem; color: var(--fairway); }
  .hc-card .hc-label { font-size: 0.78rem; color: var(--muted); margin-top: 0.25rem; }
  .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
  .metric-pill { background: var(--fairway); color: white; border-radius: 8px; padding: 1rem; }
  .metric-pill .mp-label { font-size: 0.75rem; color: var(--green-light); font-weight: 600; letter-spacing: 1px; text-transform: uppercase; }
  .metric-pill .mp-name { font-size: 1rem; font-weight: 600; margin: 0.4rem 0 0.3rem; }
  .metric-pill .mp-desc { font-size: 0.78rem; color: rgba(255,255,255,0.6); line-height: 1.4; }
  .metric-pill .mp-priority { font-family: 'DM Mono', monospace; font-size: 0.7rem; color: var(--gold-light); margin-top: 0.5rem; }

  /* â”€â”€ HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .history-item { background: white; border: 1px solid var(--border); border-radius: 10px; padding: 1.25rem; margin-bottom: 1rem; cursor: pointer; transition: all 0.2s; }
  .history-item:hover { border-color: var(--green-light); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
  .history-item .hi-date { font-size: 0.75rem; color: var(--muted); font-family: 'DM Mono', monospace; }
  .history-item .hi-title { font-weight: 600; color: var(--fairway); margin: 0.3rem 0; }
  .history-item .hi-preview { font-size: 0.82rem; color: var(--mid); line-height: 1.5; }

  .empty-state { text-align: center; padding: 3rem; color: var(--muted); }
  .empty-state .es-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.4; }

  .db-badge {
    display: inline-flex; align-items: center; gap: 0.4rem;
    background: var(--green-pale); color: var(--green);
    border-radius: 20px; padding: 0.25rem 0.75rem;
    font-size: 0.72rem; font-weight: 600;
  }
  .db-badge::before { content: 'â—'; font-size: 0.6rem; }

  /* â”€â”€ PLAIN ENGLISH CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .plain-english-card {
    background: linear-gradient(135deg, #1b4332 0%, #2d6a4f 100%);
    border-radius: 12px;
    padding: 0.85rem 1.1rem;
    margin-bottom: 1.25rem;
    color: white;
    display: none;
    animation: fadeIn 0.4s ease;
  }
  .pe-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    letter-spacing: 2px;
    color: var(--gold-light);
    text-transform: uppercase;
    margin-bottom: 0.6rem;
  }
  .pe-row {
    display: flex;
    flex-direction: column;
    gap: 0.45rem;
  }
  .pe-item {
    display: flex;
    align-items: flex-start;
    gap: 0.6rem;
    font-size: 0.83rem;
    line-height: 1.4;
    color: rgba(255,255,255,0.9);
  }
  .pe-icon {
    font-size: 0.85rem;
    flex-shrink: 0;
    margin-top: 0.05rem;
  }
  .pe-item-label {
    font-size: 0.68rem;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    flex-shrink: 0;
    min-width: 52px;
  }
  .pe-item-label.problem { color: #ff9090; }
  .pe-item-label.fix { color: var(--gold-light); }
  .pe-item-label.watch { color: var(--green-light); }
  .pe-item-text { color: rgba(255,255,255,0.88); }

  /* â”€â”€ WORK ON TODAY BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .wot-card {
    background: var(--gold);
    border-radius: 12px;
    padding: 1.25rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    width: 100%;
    text-align: left;
  }
  .wot-card:hover { background: #e8924f; transform: translateY(-1px); box-shadow: 0 6px 20px rgba(244,162,97,0.35); }
  .wot-card-left { display: flex; align-items: center; gap: 1rem; }
  .wot-icon { font-size: 2rem; }
  .wot-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; color: white; letter-spacing: 1px; }
  .wot-sub { font-size: 0.8rem; color: rgba(255,255,255,0.8); margin-top: 0.1rem; }
  .wot-arrow { font-size: 1.5rem; color: rgba(255,255,255,0.7); }

  .wot-result {
    background: var(--fairway);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    display: none;
    animation: fadeIn 0.4s ease;
  }
  .wot-result.visible { display: block; }

  /* â”€â”€ PROGRESS SNAPSHOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .progress-snapshot {
    background: white;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }
  .ps-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.1rem;
    letter-spacing: 1px;
    color: var(--green);
    margin-bottom: 1.25rem;
  }
  .ps-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 1rem;
  }
  .ps-metric {
    background: var(--cream);
    border-radius: 10px;
    padding: 1rem;
    text-align: center;
  }
  .ps-metric-name {
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 0.5rem;
  }
  .ps-metric-values {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-bottom: 0.4rem;
  }
  .ps-old { font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; color: var(--muted); }
  .ps-arrow-icon { color: var(--muted); font-size: 0.8rem; }
  .ps-new { font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; color: var(--fairway); }
  .ps-trend {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.2rem 0.6rem;
    border-radius: 20px;
    display: inline-block;
  }
  .ps-trend.better { background: var(--green-pale); color: var(--green); }
  .ps-trend.worse { background: #ffeaec; color: var(--danger); }
  .ps-trend.neutral { background: #f0f0f0; color: var(--muted); }
  .ps-caption {
    font-size: 0.78rem;
    color: var(--muted);
    margin-top: 1rem;
    text-align: center;
    font-style: italic;
  }

  /* â”€â”€ SESSION NOTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .notes-card {
    background: #fffdf5;
    border: 1.5px solid var(--gold-light);
    border-radius: 12px;
    padding: 1.25rem 1.5rem;
    margin-top: 1rem;
    display: none;
    animation: fadeIn 0.3s ease;
  }
  .notes-card.visible { display: block; }
  .notes-card label { color: var(--mid); }
  .notes-card textarea {
    border-color: #f4d06a;
    background: white;
    margin-bottom: 0.75rem;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    resize: vertical;
  }
  .notes-card textarea:focus { border-color: var(--gold); }


  /* â”€â”€ VISUAL DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .visual-dashboard {
    display: none;
    animation: fadeIn 0.4s ease;
    margin-bottom: 1.5rem;
  }
  .visual-dashboard.visible { display: block; }

  .vd-section-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    margin: 1.5rem 0 0.75rem;
  }
  .vd-section-label:first-child { margin-top: 0; }

  /* Gauge Cards */
  .gauge-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }

  .gauge-card {
    background: white;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.1rem 1.25rem;
    position: relative;
    overflow: hidden;
  }

  .gauge-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    border-radius: 12px 12px 0 0;
  }
  .gauge-card.green::before { background: var(--green-light); }
  .gauge-card.yellow::before { background: var(--gold-light); }
  .gauge-card.red::before { background: var(--danger); }

  .gauge-metric-name {
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 0.6rem;
  }

  .gauge-values {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
  }

  .gauge-actual {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    line-height: 1;
    color: var(--ink);
  }

  .gauge-unit {
    font-size: 0.9rem;
    color: var(--muted);
  }

  .gauge-target-label {
    font-size: 0.72rem;
    color: var(--muted);
    margin-left: auto;
  }

  .gauge-bar-track {
    height: 8px;
    background: #eee;
    border-radius: 20px;
    overflow: visible;
    position: relative;
    margin-bottom: 0.5rem;
  }

  .gauge-bar-range {
    position: absolute;
    height: 100%;
    border-radius: 20px;
    background: var(--green-pale);
  }

  .gauge-bar-marker {
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    transition: left 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .gauge-card.green .gauge-bar-marker { background: var(--green); }
  .gauge-card.yellow .gauge-bar-marker { background: var(--gold); }
  .gauge-card.red .gauge-bar-marker { background: var(--danger); }

  .gauge-status {
    font-size: 0.73rem;
    font-weight: 600;
  }
  .gauge-card.green .gauge-status { color: var(--green); }
  .gauge-card.yellow .gauge-status { color: #b07000; }
  .gauge-card.red .gauge-status { color: var(--danger); }

  /* Club Path Arrow Diagram */
  .path-diagram-card {
    background: white;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem;
  }

  .path-diagram-title {
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 1rem;
  }

  .path-diagram-wrap {
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }

  .path-svg-wrap { flex-shrink: 0; }

  .path-legend { flex: 1; }
  .path-legend-item {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    font-size: 0.82rem;
    color: var(--mid);
    margin-bottom: 0.6rem;
  }
  .path-legend-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  /* Drill Cards */
  .drill-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
  }

  .drill-card {
    background: white;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem;
    position: relative;
  }

  .drill-card-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .drill-badge {
    background: var(--fairway);
    color: var(--gold-light);
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.8rem;
    letter-spacing: 1px;
    padding: 0.2rem 0.6rem;
    border-radius: 4px;
    flex-shrink: 0;
  }

  .drill-name {
    font-weight: 700;
    font-size: 0.95rem;
    color: var(--fairway);
  }

  .drill-steps { margin-bottom: 1rem; }

  .drill-step {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 0.6rem;
    font-size: 0.84rem;
    color: var(--mid);
    line-height: 1.4;
  }

  .drill-step-num {
    width: 20px; height: 20px;
    border-radius: 50%;
    background: var(--green-pale);
    color: var(--green);
    font-size: 0.7rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-top: 1px;
  }

  .drill-feel-cue {
    background: #fffdf5;
    border-left: 3px solid var(--gold);
    padding: 0.6rem 0.75rem;
    border-radius: 0 8px 8px 0;
    font-size: 0.82rem;
    color: var(--mid);
    font-style: italic;
  }

  .drill-feel-cue strong {
    color: var(--ink);
    font-style: normal;
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    display: block;
    margin-bottom: 0.2rem;
  }

  /* Grip Diagram */
  .grip-cards {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }
  @media (max-width: 600px) { .grip-cards { grid-template-columns: 1fr; } }

  .grip-card {
    background: white;
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 1rem;
    text-align: center;
    transition: all 0.2s;
    opacity: 0.5;
  }

  .grip-card.highlighted {
    border-color: var(--green);
    opacity: 1;
    box-shadow: 0 4px 16px rgba(45,106,79,0.15);
  }

  .grip-card-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1rem;
    letter-spacing: 1px;
    color: var(--fairway);
    margin-bottom: 0.25rem;
  }

  .grip-card-desc {
    font-size: 0.75rem;
    color: var(--muted);
    line-height: 1.4;
  }

  .grip-card.highlighted .grip-card-desc { color: var(--mid); }

  .grip-recommended {
    display: none;
    font-size: 0.68rem;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    color: var(--green);
    margin-top: 0.5rem;
  }
  .grip-card.highlighted .grip-recommended { display: block; }

  /* Collapsible full analysis */
  .analysis-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: white;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.9rem 1.25rem;
    cursor: pointer;
    width: 100%;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.88rem;
    font-weight: 600;
    color: var(--mid);
    transition: all 0.2s;
    margin-top: 1rem;
  }
  .analysis-toggle:hover { border-color: var(--green-light); color: var(--green); background: var(--green-pale); }
  .analysis-toggle-icon { transition: transform 0.3s; font-size: 0.8rem; }
  .analysis-toggle.open .analysis-toggle-icon { transform: rotate(180deg); }
  .analysis-collapsible { display: none; margin-top: 0.5rem; }
  .analysis-collapsible.open { display: block; }


  /* â”€â”€ PATH SPECTRUM SLIDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .path-spectrum-wrap { margin: 1rem 0; }

  .path-spectrum-labels {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
  }
  .path-spec-label {
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    text-align: center;
    line-height: 1.4;
  }
  .path-spec-label.left { color: var(--danger); text-align: left; }
  .path-spec-label.center { color: var(--green); text-align: center; }
  .path-spec-label.right { color: var(--green); text-align: right; }

  .path-spectrum-track {
    position: relative;
    height: 28px;
    background: linear-gradient(to right, #e63946 0%, #f4a261 25%, #d8f3dc 40%, #52b788 50%, #d8f3dc 60%, #f4a261 75%, #e63946 100%);
    border-radius: 14px;
    margin-bottom: 1.25rem;
  }

  .path-target-zone {
    position: absolute;
    top: 0; bottom: 0;
    background: rgba(255,255,255,0.35);
    border-radius: 14px;
    border: 2px solid rgba(82,183,136,0.8);
    transition: all 0.5s ease;
  }

  .path-marker {
    position: absolute;
    top: -6px;
    transform: translateX(-50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: left 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    z-index: 2;
  }
  .path-marker-line {
    width: 4px;
    height: 40px;
    background: var(--fairway);
    border-radius: 2px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }
  .path-marker-label {
    background: var(--fairway);
    color: white;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.85rem;
    padding: 0.1rem 0.4rem;
    border-radius: 4px;
    margin-top: 3px;
    white-space: nowrap;
    letter-spacing: 0.5px;
  }

  .path-tick {
    position: absolute;
    bottom: -20px;
    transform: translateX(-50%);
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    color: var(--muted);
  }
  .path-tick.center-tick { color: var(--green); font-weight: 700; }

  .path-meaning-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-top: 2rem;
  }
  .path-meaning-box {
    flex: 1;
    background: var(--cream);
    border-radius: 10px;
    padding: 0.85rem 1rem;
    border: 1px solid var(--border);
  }
  .path-meaning-box.target {
    background: var(--green-pale);
    border-color: var(--green-light);
  }
  .path-meaning-arrow {
    font-size: 1.2rem;
    color: var(--muted);
    flex-shrink: 0;
  }
  .pmb-label {
    font-size: 0.62rem;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 0.3rem;
  }
  .pmb-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.5rem;
    color: var(--fairway);
    line-height: 1;
    margin-bottom: 0.25rem;
  }
  .pmb-desc { font-size: 0.78rem; color: var(--mid); line-height: 1.4; }

  /* â”€â”€ REALISTIC GRIP CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .grip-cards {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }
  @media (max-width: 600px) { .grip-cards { grid-template-columns: 1fr; } }

  .grip-card {
    background: white;
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 1rem;
    text-align: center;
    transition: all 0.2s;
    opacity: 0.55;
  }
  .grip-card.highlighted {
    border-color: var(--green);
    opacity: 1;
    box-shadow: 0 4px 16px rgba(45,106,79,0.15);
  }
  .grip-card-name {
    font-family: "Bebas Neue", sans-serif;
    font-size: 1rem;
    letter-spacing: 1px;
    color: var(--fairway);
    margin-bottom: 0.2rem;
  }
  .grip-card-desc {
    font-size: 0.73rem;
    color: var(--muted);
    line-height: 1.4;
    margin-bottom: 0.4rem;
  }
  .grip-card.highlighted .grip-card-desc { color: var(--mid); }
  .grip-recommended {
    display: none;
    font-size: 0.68rem;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    color: var(--green);
    margin-top: 0.4rem;
  }
  .grip-card.highlighted .grip-recommended { display: block; }

</style>
</head>
<body>

<!-- â”€â”€ AUTH SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="auth-screen">
  <div class="auth-box">
    <div class="auth-logo">Caddie <span>IQ</span></div>
    <div class="auth-tagline">Turn your Trackman data into real improvement</div>

    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchTab('login')">Sign In</button>
      <button class="auth-tab" onclick="switchTab('signup')">Create Account</button>
    </div>

    <div id="auth-error" class="auth-error"></div>
    <div id="auth-success" class="auth-success"></div>

    <!-- LOGIN FORM -->
    <div id="login-form" class="auth-form">
      <input type="email" id="login-email" placeholder="you@email.com" autocomplete="email">
      <input type="password" id="login-password" placeholder="Password" autocomplete="current-password">
      <button class="auth-btn" onclick="signIn()" id="login-btn">Sign In</button>
      <div style="text-align:center; font-size:0.8rem; color:var(--muted); margin-top:0.5rem;">
        <a href="#" onclick="resetPassword()" style="color:var(--green); text-decoration:none;">Forgot password?</a>
      </div>
    </div>

    <!-- SIGNUP FORM -->
    <div id="signup-form" class="auth-form" style="display:none;">
      <input type="email" id="signup-email" placeholder="you@email.com" autocomplete="email">
      <input type="password" id="signup-password" placeholder="Password (min 6 chars)" autocomplete="new-password">
      <button class="auth-btn" onclick="signUp()" id="signup-btn">Create Account</button>
    </div>
  </div>
</div>

<!-- â”€â”€ PROFILE SETUP SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="profile-setup-screen">
  <div class="setup-box">
    <div class="auth-logo" style="text-align:center; margin-bottom:0.25rem;">Caddie <span style="color:var(--green-light)">IQ</span></div>
    <div class="auth-tagline" style="text-align:center; margin-bottom:1.75rem;">Let's set up your golfer profile</div>
    <div class="setup-step"><div class="setup-step-dot"></div> NEW ACCOUNT â€” ONE-TIME SETUP</div>
    <div class="avatar-preview" id="setup-avatar-preview" style="background:#2d6a4f;">?</div>
    <label>Full Name <span style="color:var(--danger)">*</span></label>
    <input type="text" id="setup-fullname" placeholder="e.g. John Smith" oninput="updateAvatarPreview()">
    <label>Username <span style="color:var(--danger)">*</span> <span style="color:var(--muted); font-weight:400">â€” shown on your profile</span></label>
    <input type="text" id="setup-username" placeholder="e.g. johnsmith_golf">
    <label>Home Course <span style="color:var(--muted); font-weight:400">â€” optional</span></label>
    <input type="text" id="setup-course" placeholder="e.g. Pebble Beach Golf Links">
    <label>Location <span style="color:var(--muted); font-weight:400">â€” optional</span></label>
    <input type="text" id="setup-location" placeholder="e.g. Monterey, CA">
    <label>Pick an Avatar Color</label>
    <div class="avatar-grid" id="avatar-color-grid"></div>
    <label>Your Handicap</label>
    <select id="setup-handicap">
      <option value="">Select...</option>
      <option value="25+">25+ (Beginner)</option>
      <option value="15-24" selected>15â€“24 (Mid)</option>
      <option value="5-14">5â€“14 (Low-Mid)</option>
      <option value="0-4">0â€“4 (Scratch)</option>
    </select>
    <label>Primary Shot Goal</label>
    <select id="setup-goal">
      <option value="draw">Play a Draw</option>
      <option value="fade">Play a Fade</option>
      <option value="straight">Hit it Straight</option>
      <option value="distance">Add Distance</option>
      <option value="consistency">Improve Consistency</option>
    </select>
    <div id="setup-error" class="auth-error" style="margin-bottom:1rem;"></div>
    <button class="auth-btn" onclick="completeProfileSetup()" id="setup-btn">Start Using Caddie IQ â†’</button>
  </div>
</div>

<!-- â”€â”€ APP SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="app-shell">
  <header>
    <div class="logo">Caddie <span>IQ</span></div>
    <nav>
      <button class="active" onclick="showPanel('dashboard')">Dashboard</button>
      <button onclick="showPanel('upload')">Upload Data</button>
      <button onclick="showPanel('analyzer')">Shot Analyzer</button>
      <button onclick="showPanel('roadmap')">Improvement</button>
      <button onclick="showPanel('history')">History</button>
      <button onclick="showPanel('profile')">My Profile</button>
    </nav>
    <div class="header-user">
      <div class="user-avatar" id="header-avatar" onclick="showPanel('profile')" title="My Profile" style="background:#2d6a4f;">?</div>
      <button class="signout-btn" onclick="signOut()">Sign Out</button>
    </div>
  </header>

  <main>

    <!-- DASHBOARD -->
    <div id="panel-dashboard" class="panel active">
      <div class="section-title">Welcome Back</div>
      <p class="section-sub">Your AI-powered caddie â€” turning Trackman data into real improvement. <span class="db-badge">Cloud Synced</span></p>

      <div class="stats-row">
        <div class="stat-box"><div class="sb-val" id="stat-sessions">0</div><div class="sb-label">Sessions</div></div>
        <div class="stat-box"><div class="sb-val" id="stat-shots">0</div><div class="sb-label">Shots Logged</div></div>
        <div class="stat-box"><div class="sb-val" id="stat-handicap">â€”</div><div class="sb-label">Handicap</div></div>
        <div class="stat-box"><div class="sb-val" id="stat-analyses">0</div><div class="sb-label">Analyses</div></div>
      </div>

      <div class="card">
        <div class="card-title">âš™ï¸ Your Profile</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
          <div>
            <label>Your Handicap</label>
            <select id="profile-handicap" onchange="saveProfile()">
              <option value="">Select...</option>
              <option value="25+">25+ (Beginner)</option>
              <option value="15-24">15â€“24 (Mid)</option>
              <option value="5-14">5â€“14 (Low-Mid)</option>
              <option value="0-4">0â€“4 (Scratch)</option>
            </select>
          </div>
          <div>
            <label>Primary Shot Goal</label>
            <select id="profile-goal" onchange="saveProfile()">
              <option value="">Select...</option>
              <option value="draw">Play a Draw</option>
              <option value="fade">Play a Fade</option>
              <option value="straight">Hit it Straight</option>
              <option value="distance">Add Distance</option>
              <option value="consistency">Improve Consistency</option>
            </select>
          </div>
        </div>
      </div>

      <!-- WORK ON TODAY BUTTON -->
      <button class="wot-card" onclick="getWorkOnToday()">
        <div class="wot-card-left">
          <div class="wot-icon">ğŸ¯</div>
          <div>
            <div class="wot-title">What Should I Work On Today?</div>
            <div class="wot-sub">AI picks your focus based on your last sessions</div>
          </div>
        </div>
        <div class="wot-arrow">â†’</div>
      </button>

      <!-- WORK ON TODAY RESULT -->
      <div id="wot-result" class="wot-result">
        <div class="ai-label">TODAY'S PRACTICE FOCUS</div>
        <div class="ai-body" id="wot-body"></div>
      </div>

      <!-- PROGRESS SNAPSHOT -->
      <div id="progress-snapshot" class="progress-snapshot" style="display:none;">
        <div class="ps-title">ğŸ“ˆ Your Progress</div>
        <div class="ps-metrics" id="ps-metrics-grid"></div>
        <div class="ps-caption" id="ps-caption"></div>
      </div>

      <div id="recent-analyses-wrap">
        <div class="card-title" style="font-family:'Bebas Neue'; font-size:1.1rem; letter-spacing:1px; color:var(--green); margin-bottom:1rem;">ğŸ“‹ Recent Analyses</div>
        <div class="empty-state">
          <div class="es-icon">ğŸŒï¸</div>
          <p>No analyses yet. Upload Trackman data or use the Shot Analyzer to get started.</p>
          <br>
          <button class="btn btn-primary" onclick="showPanel('upload')">Upload Data â†’</button>
        </div>
      </div>
    </div>

    <!-- UPLOAD -->
    <div id="panel-upload" class="panel">
      <div class="section-title">Upload Trackman Data</div>
      <p class="section-sub">Drop your CSV export from Trackman, FlightScope, or any golf launch monitor.</p>

      <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()"
        ondragover="event.preventDefault(); this.classList.add('dragover')"
        ondragleave="this.classList.remove('dragover')"
        ondrop="handleDrop(event)">
        <div class="upload-icon">ğŸ“‚</div>
        <h3>Drop your CSV here or click to browse</h3>
        <p>Supports Trackman (.csv), FlightScope (.csv), or any standard golf launch monitor export</p>
      </div>
      <input type="file" id="file-input" accept=".csv,.txt" onchange="handleFileSelect(event)">

      <div id="parse-status" style="margin-top:1rem;"></div>

      <div id="data-preview" style="display:none;">
        <div class="card">
          <div class="card-title">ğŸ“Š Parsed Shot Data</div>
          <div class="data-table-wrap" id="table-container"></div>

          <!-- SESSION NOTES -->
          <div class="notes-card visible" style="margin-top:1rem;">
            <label>ğŸ“ Session Notes <span style="color:var(--muted); font-weight:400">â€” optional, helps the AI and your instructor</span></label>
            <textarea id="session-notes" rows="2" placeholder="e.g. Felt like I was coming over the top today. Trying to work on shallowing the club..."></textarea>
          </div>
          <br>
          <button class="btn btn-primary" onclick="analyzeUploadedData()" id="analyze-btn">ğŸ¤– Analyze with AI Caddie</button>
        </div>
      </div>

      <!-- PLAIN ENGLISH CARD -->
      <div id="pe-card-upload" class="plain-english-card">
        <div class="pe-label">âš¡ Quick Take</div>
        <div class="pe-row">
          <div class="pe-item">
            <span class="pe-icon">ğŸ”´</span>
            <span class="pe-item-label problem">Problem</span>
            <span class="pe-item-text" id="pe-problem-upload">â€”</span>
          </div>
          <div class="pe-item">
            <span class="pe-icon">ğŸ¯</span>
            <span class="pe-item-label fix">Fix</span>
            <span class="pe-item-text" id="pe-fix-upload">â€”</span>
          </div>
          <div class="pe-item">
            <span class="pe-icon">ğŸ‘€</span>
            <span class="pe-item-label watch">Watch</span>
            <span class="pe-item-text" id="pe-watch-upload">â€”</span>
          </div>
        </div>
      </div>

      <!-- VISUAL DASHBOARD -->
      <div id="visual-dashboard" class="visual-dashboard">

        <div class="vd-section-label">ğŸ“Š Your Numbers vs Target</div>
        <div class="gauge-grid" id="gauge-grid"></div>

        <div class="vd-section-label">ğŸ¹ Club Path</div>
        <div class="path-diagram-card">
          <div class="path-diagram-title">Swing Direction â€” Out-to-In â† Neutral â†’ In-to-Out</div>

          <!-- Spectrum slider -->
          <div class="path-spectrum-wrap">
            <div class="path-spectrum-labels">
              <span class="path-spec-label left">OUT-TO-IN<br><span style="font-weight:400;color:var(--danger)">Fade / Slice</span></span>
              <span class="path-spec-label center">NEUTRAL<br><span style="font-weight:400;color:var(--green)">0Â°</span></span>
              <span class="path-spec-label right">IN-TO-OUT<br><span style="font-weight:400;color:var(--green)">Draw</span></span>
            </div>
            <div class="path-spectrum-track" id="path-spectrum-track">
              <!-- Green target zone injected by JS -->
              <div class="path-target-zone" id="path-target-zone"></div>
              <!-- Marker -->
              <div class="path-marker" id="path-marker">
                <div class="path-marker-line"></div>
                <div class="path-marker-label" id="path-marker-label">0Â°</div>
              </div>
              <!-- Scale ticks -->
              <div class="path-tick" style="left:0%"><span>-10Â°</span></div>
              <div class="path-tick" style="left:25%"><span>-5Â°</span></div>
              <div class="path-tick center-tick" style="left:50%"><span>0Â°</span></div>
              <div class="path-tick" style="left:75%"><span>+5Â°</span></div>
              <div class="path-tick" style="left:100%"><span>+10Â°</span></div>
            </div>
          </div>

          <!-- What it means -->
          <div class="path-meaning-row">
            <div class="path-meaning-box" id="path-meaning-current">
              <div class="pmb-label">YOUR PATH</div>
              <div class="pmb-value" id="path-value-display">â€”</div>
              <div class="pmb-desc" id="path-desc-display">â€”</div>
            </div>
            <div class="path-meaning-arrow">â†’</div>
            <div class="path-meaning-box target">
              <div class="pmb-label">TARGET</div>
              <div class="pmb-value" id="path-target-display">â€”</div>
              <div class="pmb-desc" id="path-target-desc">â€”</div>
            </div>
          </div>
        </div>

        <div class="vd-section-label">ğŸ‹ï¸ Recommended Drill</div>
        <div class="drill-cards-grid" id="drill-cards-grid"></div>

        <div class="vd-section-label">âœ‹ Grip Recommendation</div>
        <div class="grip-cards" id="grip-cards"></div>

      </div>

      <!-- COLLAPSIBLE FULL ANALYSIS -->
      <div id="full-analysis-wrap" style="display:none;">
        <button class="analysis-toggle" onclick="toggleFullAnalysis(this)">
          <span>ğŸ“„ Read Full Analysis</span>
          <span class="analysis-toggle-icon">â–¼</span>
        </button>
        <div class="analysis-collapsible">
          <div id="upload-analysis" class="ai-response" style="margin-top:0;"></div>
        </div>
      </div>

      <div class="card" style="margin-top:1.5rem;">
        <div class="card-title">ğŸ’¡ How to Export from Trackman</div>
        <p style="font-size:0.85rem; color:var(--mid); line-height:1.7;">
          In the Trackman app â†’ <strong>My Sessions</strong> â†’ select your session â†’ tap <strong>Share/Export</strong> â†’ choose <strong>CSV</strong>.
          The file will include Club Speed, Ball Speed, Launch Angle, Spin Rate, Carry Distance, Club Path, Face Angle, Attack Angle, Spin Axis, and more.
        </p>
      </div>

      <div class="card">
        <div class="card-title">ğŸ§ª Try a Demo Dataset</div>
        <p style="font-size:0.85rem; color:var(--mid); margin-bottom:1rem;">Don't have a CSV? Load a sample 7-iron session showing a classic fade pattern.</p>
        <button class="btn btn-outline" onclick="loadDemoData()">Load Demo Data</button>
      </div>
    </div>

    <!-- SHOT ANALYZER -->
    <div id="panel-analyzer" class="panel">
      <div class="section-title">Shot Analyzer</div>
      <p class="section-sub">Enter any Trackman numbers to diagnose exactly what your ball is doing and why.</p>

      <div class="analyzer-grid">
        <div>
          <div class="card">
            <div class="card-title">ğŸ¯ Shot Parameters</div>

            <label>Club</label>
            <select id="a-club">
              <option>Driver</option><option>3 Wood</option><option>5 Wood</option>
              <option>4 Iron</option><option>5 Iron</option><option>6 Iron</option>
              <option selected>7 Iron</option><option>8 Iron</option><option>9 Iron</option>
              <option>PW</option><option>GW</option><option>SW</option><option>LW</option>
            </select>

            <label>Desired Shot Shape</label>
            <select id="a-shape">
              <option value="draw">Draw</option>
              <option value="fade">Fade</option>
              <option value="straight">Straight</option>
            </select>

            <hr class="divider">

            <label>Club Path (Â°) <span style="color:var(--muted); font-weight:400">â€” + is In-to-Out, âˆ’ is Out-to-In</span></label>
            <input type="number" id="a-path" placeholder="-3.2" step="0.1">

            <label>Face Angle (Â°) <span style="color:var(--muted); font-weight:400">â€” + is Open, âˆ’ is Closed</span></label>
            <input type="number" id="a-face" placeholder="+1.5" step="0.1">

            <label>Attack Angle (Â°)</label>
            <input type="number" id="a-attack" placeholder="-4.0" step="0.1">

            <label>Spin Rate (rpm)</label>
            <input type="number" id="a-spin" placeholder="6800">

            <label>Spin Axis (Â°) <span style="color:var(--muted); font-weight:400">â€” + tilts right (fade), âˆ’ tilts left (draw)</span></label>
            <input type="number" id="a-spinaxis" placeholder="+8" step="0.1">

            <label>Ball Speed (mph)</label>
            <input type="number" id="a-ballspeed" placeholder="118">

            <label>Club Speed (mph)</label>
            <input type="number" id="a-clubspeed" placeholder="82">

            <button class="btn btn-primary" onclick="runShotAnalysis()" id="shot-btn" style="width:100%">
              ğŸ¤– Analyze My Shot
            </button>
          </div>
        </div>

        <div>
          <div class="card">
            <div class="card-title">ğŸ“ Ball Flight Visualizer</div>
            <div class="shot-viz" id="shot-viz">
              <svg width="220" height="120" viewBox="0 0 220 120">
                <line x1="110" y1="10" x2="110" y2="110" stroke="rgba(255,255,255,0.1)" stroke-width="1" stroke-dasharray="4"/>
                <text x="90" y="118" fill="rgba(255,255,255,0.3)" font-size="9">TARGET LINE</text>
                <path id="shot-svg-path" d="M110,110 Q110,60 110,15" stroke="rgba(82,183,136,0.4)" fill="none" stroke-width="2.5" stroke-linecap="round"/>
              </svg>
              <div style="position:absolute; bottom:0.75rem; left:50%; transform:translateX(-50%); font-size:0.72rem; color:rgba(255,255,255,0.35); font-family:'DM Mono'; white-space:nowrap;">
                Updates live as you type
              </div>
            </div>
          </div>

          <!-- PLAIN ENGLISH CARD - SHOT ANALYZER -->
          <div id="pe-card-shot" class="plain-english-card">
            <div class="pe-label">âš¡ Quick Take</div>
            <div class="pe-row">
              <div class="pe-item">
                <span class="pe-icon">ğŸ”´</span>
                <span class="pe-item-label problem">Problem</span>
                <span class="pe-item-text" id="pe-problem-shot">â€”</span>
              </div>
              <div class="pe-item">
                <span class="pe-icon">ğŸ¯</span>
                <span class="pe-item-label fix">Fix</span>
                <span class="pe-item-text" id="pe-fix-shot">â€”</span>
              </div>
              <div class="pe-item">
                <span class="pe-icon">ğŸ‘€</span>
                <span class="pe-item-label watch">Watch</span>
                <span class="pe-item-text" id="pe-watch-shot">â€”</span>
              </div>
            </div>
          </div>

          <div id="shot-analysis" class="ai-response"></div>
        </div>
      </div>
    </div>

    <!-- ROADMAP -->
    <div id="panel-roadmap" class="panel">
      <div class="section-title">Improvement Roadmap</div>
      <p class="section-sub">Personalized focus areas based on your handicap. Tap a level to see your priority metrics.</p>

      <div class="handicap-grid">
        <div class="hc-card" onclick="selectHandicap(this, '25+')">
          <div class="hc-range">25+</div><div class="hc-label">Beginner</div>
        </div>
        <div class="hc-card selected" onclick="selectHandicap(this, '15-24')">
          <div class="hc-range">15â€“24</div><div class="hc-label">Mid Handicap</div>
        </div>
        <div class="hc-card" onclick="selectHandicap(this, '5-14')">
          <div class="hc-range">5â€“14</div><div class="hc-label">Low-Mid</div>
        </div>
        <div class="hc-card" onclick="selectHandicap(this, '0-4')">
          <div class="hc-range">0â€“4</div><div class="hc-label">Scratch</div>
        </div>
      </div>

      <div id="roadmap-content"></div>

      <div class="card" style="margin-top:1.5rem;">
        <div class="card-title">ğŸ¤– Ask Your Caddie</div>
        <label>What are you struggling with?</label>
        <textarea id="roadmap-question" rows="3" placeholder="e.g. I keep pulling my 7 iron left and losing distance. My club path is -4 and face is +2..."></textarea>
        <button class="btn btn-primary" onclick="getRoadmapAdvice()">Get Advice</button>
      </div>

      <div id="roadmap-advice" class="ai-response" style="margin-top:1.5rem;"></div>
    </div>

    <!-- HISTORY -->
    <div id="panel-history" class="panel">
      <div class="section-title">Session History</div>
      <p class="section-sub">All analyses saved to your account â€” synced across every device. <span class="db-badge">Cloud Synced</span></p>

      <div id="history-list">
        <div class="empty-state"><div class="es-icon">ğŸ“‚</div><p>Loading your history...</p></div>
      </div>

      <div style="margin-top:1.5rem; text-align:right;">
        <button class="btn btn-outline" onclick="exportHistory()">ğŸ“¥ Export JSON</button>
        <button class="btn" style="background:#fff0f0; color:var(--danger); margin-left:0.5rem;" onclick="clearHistory()">ğŸ—‘ Clear All</button>
      </div>
    </div>

    <!-- MY PROFILE PANEL -->
    <div id="panel-profile" class="panel">
      <div class="section-title">My Profile</div>
      <p class="section-sub">Your golfer identity â€” update anytime.</p>

      <div class="profile-info-card" id="profile-display-card">
        <div class="profile-big-avatar" id="profile-big-avatar" style="background:#2d6a4f;">?</div>
        <div>
          <div class="profile-info-name" id="profile-display-name">â€”</div>
          <div class="profile-info-username" id="profile-display-username"></div>
          <div class="profile-info-meta" id="profile-display-meta"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">âœï¸ Edit Profile</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
          <div>
            <label>Full Name</label>
            <input type="text" id="edit-fullname" placeholder="Your full name">
          </div>
          <div>
            <label>Username</label>
            <input type="text" id="edit-username" placeholder="your_username">
          </div>
          <div>
            <label>Home Course</label>
            <input type="text" id="edit-course" placeholder="Your home course">
          </div>
          <div>
            <label>Location</label>
            <input type="text" id="edit-location" placeholder="City, State">
          </div>
          <div>
            <label>Handicap</label>
            <select id="edit-handicap">
              <option value="">Select...</option>
              <option value="25+">25+ (Beginner)</option>
              <option value="15-24">15â€“24 (Mid)</option>
              <option value="5-14">5â€“14 (Low-Mid)</option>
              <option value="0-4">0â€“4 (Scratch)</option>
            </select>
          </div>
          <div>
            <label>Shot Goal</label>
            <select id="edit-goal">
              <option value="draw">Play a Draw</option>
              <option value="fade">Play a Fade</option>
              <option value="straight">Hit it Straight</option>
              <option value="distance">Add Distance</option>
              <option value="consistency">Improve Consistency</option>
            </select>
          </div>
        </div>
        <label style="margin-top:0.5rem;">Avatar Color</label>
        <div class="avatar-grid" id="edit-avatar-grid"></div>
        <br>
        <button class="btn btn-primary" onclick="saveEditedProfile()">ğŸ’¾ Save Changes</button>
        <span id="profile-save-msg" style="margin-left:1rem; font-size:0.85rem; color:var(--green); display:none;">âœ… Saved!</span>
      </div>

      <div class="card" style="background:#fff8f8; border-color:#ffd0d0;">
        <div class="card-title" style="color:var(--danger);">âš ï¸ Account</div>
        <p style="font-size:0.85rem; color:var(--mid); margin-bottom:1rem;">Signed in as <strong id="profile-email-display"></strong></p>
        <button class="btn" style="background:#fff0f0; color:var(--danger); border:1px solid #ffb3ba;" onclick="signOut()">Sign Out</button>
      </div>
    </div>

  </main>
</div>

<script>
// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// âš ï¸  REPLACE THESE with your actual Supabase project values
// Find them at: supabase.com â†’ your project â†’ Settings â†’ API
const SUPABASE_URL = 'https://lcedamercezvwpombihf.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjZWRhbWVyY2V6dndwb21iaWhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NjE2MzUsImV4cCI6MjA4NzAzNzYzNX0.r0m6f4ycWDlWEfMPGn5HV0ZL7Rs9G3kKuHy5iI1bngU';

// â”€â”€â”€ SUPABASE INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;
let userProfile = { handicap: '15-24', goal: 'draw', full_name: '', username: '', avatar_color: '#2d6a4f', home_course: '', location: '' };

// â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function initAuth() {
  const { data: { session } } = await db.auth.getSession();
  if (session) {
    await onSignedIn(session.user);
  }

  db.auth.onAuthStateChange(async (event, session) => {
    if (event === 'SIGNED_IN' && session) {
      await onSignedIn(session.user);
    } else if (event === 'SIGNED_OUT') {
      onSignedOut();
    }
  });
}

async function onSignedIn(user) {
  currentUser = user;
  document.getElementById('auth-screen').style.display = 'none';

  const { data: existingProfile } = await db
    .from('profiles').select('full_name').eq('user_id', user.id).single();

  if (!existingProfile || !existingProfile.full_name) {
    // New user â€” show profile setup
    document.getElementById('profile-setup-screen').style.display = 'flex';
    initAvatarGrid('avatar-color-grid');
    return;
  }

  await showApp(user);
}

async function showApp(user) {
  document.getElementById('profile-setup-screen').style.display = 'none';
  document.getElementById('app-shell').style.display = 'block';
  await loadProfile();
  await loadHistory();
  renderRoadmap(userProfile.handicap || '15-24');
  buildProgressSnapshot();
}

function onSignedOut() {
  currentUser = null;
  document.getElementById('app-shell').style.display = 'none';
  document.getElementById('profile-setup-screen').style.display = 'none';
  document.getElementById('auth-screen').style.display = 'flex';
}

function switchTab(tab) {
  document.querySelectorAll('.auth-tab').forEach((t, i) => {
    t.classList.toggle('active', (i === 0 && tab === 'login') || (i === 1 && tab === 'signup'));
  });
  document.getElementById('login-form').style.display = tab === 'login' ? 'flex' : 'none';
  document.getElementById('signup-form').style.display = tab === 'signup' ? 'flex' : 'none';
  clearAuthMessages();
}

function showAuthError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg; el.style.display = 'block';
  document.getElementById('auth-success').style.display = 'none';
}
function showAuthSuccess(msg) {
  const el = document.getElementById('auth-success');
  el.textContent = msg; el.style.display = 'block';
  document.getElementById('auth-error').style.display = 'none';
}
function clearAuthMessages() {
  document.getElementById('auth-error').style.display = 'none';
  document.getElementById('auth-success').style.display = 'none';
}

async function signIn() {
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  if (!email || !password) return showAuthError('Please enter your email and password.');

  const btn = document.getElementById('login-btn');
  btn.disabled = true; btn.textContent = 'Signing in...';

  const { error } = await db.auth.signInWithPassword({ email, password });
  if (error) showAuthError(error.message);

  btn.disabled = false; btn.textContent = 'Sign In';
}

async function signUp() {
  const email = document.getElementById('signup-email').value.trim();
  const password = document.getElementById('signup-password').value;
  if (!email || !password) return showAuthError('Please fill in all fields.');
  if (password.length < 6) return showAuthError('Password must be at least 6 characters.');

  const btn = document.getElementById('signup-btn');
  btn.disabled = true; btn.textContent = 'Creating account...';

  const { error } = await db.auth.signUp({ email, password });
  if (error) showAuthError(error.message);
  else showAuthSuccess('Account created! Check your email to confirm, then sign in.');

  btn.disabled = false; btn.textContent = 'Create Account';
}

async function signOut() {
  await db.auth.signOut();
}

async function resetPassword() {
  const email = document.getElementById('login-email').value.trim();
  if (!email) return showAuthError('Enter your email address above first.');
  const { error } = await db.auth.resetPasswordForEmail(email);
  if (error) showAuthError(error.message);
  else showAuthSuccess('Password reset email sent! Check your inbox.');
}

// â”€â”€â”€ PROFILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadProfile() {
  if (!currentUser) return;

  const { data } = await db
    .from('profiles').select('*').eq('user_id', currentUser.id).single();

  if (data) {
    userProfile = {
      handicap: data.handicap || '15-24',
      goal: data.goal || 'draw',
      full_name: data.full_name || '',
      username: data.username || '',
      avatar_color: data.avatar_color || '#2d6a4f',
      home_course: data.home_course || '',
      location: data.location || ''
    };
  }

  // Dashboard profile selects
  const hEl = document.getElementById('profile-handicap');
  const gEl = document.getElementById('profile-goal');
  if (hEl) hEl.value = userProfile.handicap || '';
  if (gEl) gEl.value = userProfile.goal || '';
  document.getElementById('stat-handicap').textContent = userProfile.handicap || 'â€”';

  // Header avatar
  updateHeaderAvatar();

  // Populate edit form
  const ef = document.getElementById('edit-fullname');
  if (ef) {
    ef.value = userProfile.full_name || '';
    document.getElementById('edit-username').value = userProfile.username || '';
    document.getElementById('edit-course').value = userProfile.home_course || '';
    document.getElementById('edit-location').value = userProfile.location || '';
    document.getElementById('edit-handicap').value = userProfile.handicap || '';
    document.getElementById('edit-goal').value = userProfile.goal || '';
    document.getElementById('profile-email-display').textContent = currentUser.email;
  }

  // Profile display card
  renderProfileCard();
  initAvatarGrid('edit-avatar-grid', userProfile.avatar_color);
}

function updateHeaderAvatar() {
  const el = document.getElementById('header-avatar');
  if (!el) return;
  const initials = getInitials(userProfile.full_name) || '?';
  el.textContent = initials;
  el.style.background = userProfile.avatar_color || '#2d6a4f';
}

function getInitials(name) {
  if (!name) return '?';
  const parts = name.trim().split(' ');
  if (parts.length >= 2) return (parts[0][0] + parts[parts.length-1][0]).toUpperCase();
  return name.substring(0, 2).toUpperCase();
}

function renderProfileCard() {
  const bigAvatar = document.getElementById('profile-big-avatar');
  const nameEl = document.getElementById('profile-display-name');
  const usernameEl = document.getElementById('profile-display-username');
  const metaEl = document.getElementById('profile-display-meta');
  if (!bigAvatar) return;

  bigAvatar.textContent = getInitials(userProfile.full_name);
  bigAvatar.style.background = userProfile.avatar_color || '#2d6a4f';
  nameEl.textContent = userProfile.full_name || currentUser?.email || 'â€”';
  usernameEl.textContent = userProfile.username ? '@' + userProfile.username : '';

  let meta = [];
  if (userProfile.handicap) meta.push('â›³ ' + userProfile.handicap + ' Handicap');
  if (userProfile.home_course) meta.push('ğŸŒï¸ ' + userProfile.home_course);
  if (userProfile.location) meta.push('ğŸ“ ' + userProfile.location);
  metaEl.innerHTML = meta.join('<br>');
}

const AVATAR_COLORS = ['#2d6a4f','#1b4332','#52b788','#f4a261','#e63946','#457b9d','#6a2d6a','#8b4513','#2c3e8c','#4a4a6a'];

function initAvatarGrid(gridId, selectedColor) {
  const grid = document.getElementById(gridId);
  if (!grid) return;
  grid.innerHTML = '';
  const sel = selectedColor || userProfile.avatar_color || '#2d6a4f';
  AVATAR_COLORS.forEach(color => {
    const div = document.createElement('div');
    div.className = 'avatar-swatch' + (color === sel ? ' selected' : '');
    div.style.background = color;
    div.onclick = () => {
      grid.querySelectorAll('.avatar-swatch').forEach(s => s.classList.remove('selected'));
      div.classList.add('selected');
      userProfile.avatar_color = color;
      // Update preview if on setup screen
      const prev = document.getElementById('setup-avatar-preview');
      if (prev) prev.style.background = color;
    };
    grid.appendChild(div);
  });
}

function updateAvatarPreview() {
  const name = document.getElementById('setup-fullname')?.value || '';
  const prev = document.getElementById('setup-avatar-preview');
  if (prev) prev.textContent = getInitials(name) || '?';
}

async function saveProfile() {
  if (!currentUser) return;
  const handicap = document.getElementById('profile-handicap').value;
  const goal = document.getElementById('profile-goal').value;
  userProfile.handicap = handicap;
  userProfile.goal = goal;

  await db.from('profiles').upsert({
    user_id: currentUser.id,
    handicap, goal,
    updated_at: new Date().toISOString()
  }, { onConflict: 'user_id' });

  document.getElementById('stat-handicap').textContent = handicap || 'â€”';
}

async function completeProfileSetup() {
  const fullName = document.getElementById('setup-fullname').value.trim();
  const username = document.getElementById('setup-username').value.trim().toLowerCase().replace(/[^a-z0-9_]/g,'');
  const course = document.getElementById('setup-course').value.trim();
  const location = document.getElementById('setup-location').value.trim();
  const handicap = document.getElementById('setup-handicap').value;
  const goal = document.getElementById('setup-goal').value;

  const errEl = document.getElementById('setup-error');
  if (!fullName) { errEl.textContent = 'Please enter your full name.'; errEl.style.display='block'; return; }
  if (!username) { errEl.textContent = 'Please enter a username.'; errEl.style.display='block'; return; }
  errEl.style.display = 'none';

  const btn = document.getElementById('setup-btn');
  btn.disabled = true; btn.textContent = 'Saving...';

  const avatarColor = userProfile.avatar_color || '#2d6a4f';

  const { error } = await db.from('profiles').upsert({
    user_id: currentUser.id,
    full_name: fullName,
    username,
    home_course: course,
    location,
    handicap: handicap || '15-24',
    goal: goal || 'draw',
    avatar_color: avatarColor,
    joined_at: new Date().toISOString(),
    updated_at: new Date().toISOString()
  }, { onConflict: 'user_id' });

  if (error) {
    errEl.textContent = error.message.includes('unique') ? 'That username is already taken. Try another.' : error.message;
    errEl.style.display = 'block';
    btn.disabled = false; btn.textContent = 'Start Using Caddie IQ â†’';
    return;
  }

  userProfile = { full_name: fullName, username, home_course: course, location, handicap: handicap || '15-24', goal: goal || 'draw', avatar_color: avatarColor };
  btn.disabled = false;
  await showApp(currentUser);
}

async function saveEditedProfile() {
  if (!currentUser) return;
  const fullName = document.getElementById('edit-fullname').value.trim();
  const username = document.getElementById('edit-username').value.trim().toLowerCase().replace(/[^a-z0-9_]/g,'');
  const course = document.getElementById('edit-course').value.trim();
  const location = document.getElementById('edit-location').value.trim();
  const handicap = document.getElementById('edit-handicap').value;
  const goal = document.getElementById('edit-goal').value;

  const { error } = await db.from('profiles').upsert({
    user_id: currentUser.id,
    full_name: fullName, username,
    home_course: course, location,
    handicap, goal,
    avatar_color: userProfile.avatar_color,
    updated_at: new Date().toISOString()
  }, { onConflict: 'user_id' });

  if (!error) {
    userProfile = { ...userProfile, full_name: fullName, username, home_course: course, location, handicap, goal };
    updateHeaderAvatar();
    renderProfileCard();
    document.getElementById('stat-handicap').textContent = handicap || 'â€”';
    const msg = document.getElementById('profile-save-msg');
    msg.style.display = 'inline'; setTimeout(() => msg.style.display = 'none', 3000);
  }
}

// â”€â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPanel(name) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  const names = ['dashboard', 'upload', 'analyzer', 'roadmap', 'history', 'profile'];
  document.querySelectorAll('nav button')[names.indexOf(name)]?.classList.add('active');
  if (name === 'roadmap') renderRoadmap(userProfile.handicap || '15-24');
  if (name === 'history') loadHistory();
  if (name === 'profile') { renderProfileCard(); initAvatarGrid('edit-avatar-grid', userProfile.avatar_color); }
  if (name === 'dashboard') buildProgressSnapshot();
}

// â”€â”€â”€ CLAUDE API (via Vercel function â€” key is safe on server) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function askClaude(prompt, systemPrompt) {
  const res = await fetch('/api/analyze', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ prompt, systemPrompt })
  });
  const data = await res.json();
  if (data.error) throw new Error(data.error);
  return data.result;
}

function streamToElement(el, text) {
  el.innerHTML = '';
  const words = text.split(' ');
  let i = 0;
  function next() {
    if (i < words.length) {
      el.innerHTML = (el.innerHTML + (i > 0 ? ' ' : '') + words[i++])
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      setTimeout(next, 12);
    }
  }
  next();
}

// â”€â”€â”€ FILE UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let parsedData = [];
let parsedFilename = '';

function handleDrop(e) {
  e.preventDefault();
  document.getElementById('upload-zone').classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file) processFile(file);
}

function handleFileSelect(e) {
  const file = e.target.files[0];
  if (file) processFile(file);
}

function processFile(file) {
  parsedFilename = file.name;
  const reader = new FileReader();
  reader.onload = (e) => parseCSV(e.target.result, file.name);
  reader.readAsText(file);
}

function parseCSV(text, filename) {
  const lines = text.trim().split('\n');
  if (lines.length < 2) {
    document.getElementById('parse-status').innerHTML = '<span style="color:var(--danger)">âš ï¸ File appears empty or invalid.</span>';
    return;
  }
  const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
  parsedData = [];
  for (let i = 1; i < lines.length; i++) {
    const vals = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
    if (vals.length < 2) continue;
    const row = {};
    headers.forEach((h, idx) => { row[h] = vals[idx] || ''; });
    parsedData.push(row);
  }
  document.getElementById('parse-status').innerHTML =
    `<span style="color:var(--green)">âœ… Parsed <strong>${parsedData.length} shots</strong> from ${filename}</span>`;
  renderTable(parsedData, Object.keys(parsedData[0]).slice(0, 12));
  document.getElementById('data-preview').style.display = 'block';
}

function renderTable(data, headers) {
  let html = '<table><thead><tr>';
  headers.forEach(h => { html += `<th>${h}</th>`; });
  html += '</tr></thead><tbody>';
  data.slice(0, 20).forEach(row => {
    html += '<tr>';
    headers.forEach(h => { html += `<td>${row[h] || 'â€”'}</td>`; });
    html += '</tr>';
  });
  if (data.length > 20) html += `<tr><td colspan="${headers.length}" style="color:var(--muted); text-align:center; padding:0.75rem;">... and ${data.length - 20} more shots</td></tr>`;
  html += '</tbody></table>';
  document.getElementById('table-container').innerHTML = html;
}

function loadDemoData() {
  const demoCSV = `Shot,Club,Club Speed,Ball Speed,Launch Angle,Spin Rate,Carry Distance,Club Path,Face Angle,Attack Angle,Spin Axis,Smash Factor
1,7 Iron,82,118,-4.5,7200,155,-3.2,+1.8,-4.2,+9,1.44
2,7 Iron,80,115,-4.8,7450,148,-4.1,+2.1,-4.5,+11,1.44
3,7 Iron,83,120,-4.0,6900,160,-2.8,+1.4,-4.0,+7,1.45
4,7 Iron,79,113,-5.2,7800,143,-5.0,+2.8,-4.8,+14,1.43
5,7 Iron,82,117,-4.6,7300,153,-3.5,+1.9,-4.3,+10,1.43
6,7 Iron,81,116,-4.7,7100,152,-2.9,+1.2,-4.1,+8,1.43
7,7 Iron,84,121,-3.8,6800,162,-3.0,+1.5,-3.9,+8,1.44
8,7 Iron,80,115,-4.9,7600,146,-4.5,+2.5,-4.6,+12,1.44
9,7 Iron,82,118,-4.4,7250,155,-3.3,+1.7,-4.2,+9,1.44
10,7 Iron,83,119,-4.2,7050,158,-3.1,+1.6,-4.0,+8,1.43`;
  parseCSV(demoCSV, 'Demo_7Iron_Session.csv');
  document.getElementById('a-path').value = '-3.5';
  document.getElementById('a-face').value = '1.8';
  document.getElementById('a-attack').value = '-4.3';
  document.getElementById('a-spin').value = '7200';
  document.getElementById('a-spinaxis').value = '9';
  document.getElementById('a-ballspeed').value = '118';
  document.getElementById('a-clubspeed').value = '82';
  updateShotViz();
}

async function analyzeUploadedData() {
  if (!parsedData.length) return;
  const btn = document.getElementById('analyze-btn');
  btn.disabled = true; btn.textContent = 'â³ Analyzing...';

  const handicap = userProfile.handicap || '15-24';
  const goal = userProfile.goal || 'draw';
  const notes = document.getElementById('session-notes')?.value?.trim() || '';

  // Build visuals immediately from CSV data â€” no need to wait for AI
  buildVisualDashboard(parsedData, handicap, goal);
  buildProgressSnapshot();

  const responseEl = document.getElementById('upload-analysis');
  responseEl.className = 'ai-response visible';
  responseEl.innerHTML = '<div class="ai-label">CADDIE IQ ANALYZING</div><div class="loading"><div class="spinner"></div>Building your AI analysis...</div>';

  const sample = parsedData.slice(0, 10).map(r => JSON.stringify(r)).join('\n');

  const prompt = `Analyze this Trackman golf session data for a ${handicap} handicap golfer whose goal is to hit a ${goal}.
${notes ? `Golfer's own notes from this session: "${notes}"` : ''}

Data:
${sample}
Total shots: ${parsedData.length}

Please provide two sections:

PLAIN_ENGLISH_JSON (output this exact JSON first, no markdown):
{"problem":"one sentence, plain English, what is wrong with their ball flight","fix":"one sentence, a simple feel cue they can use on the range","watch":"one metric and target number to focus on"}

Then provide the full analysis:
1. **Shot Pattern Summary** â€” What is the dominant ball flight and why?
2. **The D-Plane Explained** â€” Simply explain what their data says about why the ball curves.
3. **Top 3 Fixes** â€” Specific, actionable changes to achieve their desired ${goal}.
4. **Consistency Check** â€” Any concerning variance in the data?
5. **One Drill** â€” The single best drill for a ${handicap} handicap golfer right now.
${notes ? '6. **Session Notes Response** â€” Respond to the golfer\'s own notes above.' : ''}`;

  try {
    const result = await askClaude(prompt);

    // Extract plain english JSON - handles ```json blocks and raw JSON
    let pe = null;
    try {
      // Try ```json block first
      const codeMatch = result.match(/```json\s*([\s\S]*?)```/);
      if (codeMatch) pe = JSON.parse(codeMatch[1].trim());
    } catch(e) {}
    if (!pe) {
      try {
        // Try raw JSON object with "problem" key
        const rawMatch = result.match(/\{[\s\S]*?"problem"[\s\S]*?"fix"[\s\S]*?"watch"[\s\S]*?\}/);
        if (rawMatch) pe = JSON.parse(rawMatch[0]);
      } catch(e) {}
    }
    if (pe) {
      document.getElementById('pe-problem-upload').textContent = pe.problem || 'â€”';
      document.getElementById('pe-fix-upload').textContent = pe.fix || 'â€”';
      document.getElementById('pe-watch-upload').textContent = pe.watch || 'â€”';
      document.getElementById('pe-card-upload').style.display = 'block';
    }

    // Strip ALL json blocks and PLAIN_ENGLISH_JSON label from displayed text
    let cleanResult = result
      .replace(/PLAIN_ENGLISH_JSON[\s\S]*?```json[\s\S]*?```/, '')
      .replace(/```json[\s\S]*?```/g, '')
      .replace(/PLAIN_ENGLISH_JSON/g, '')
      .replace(/^\s*\{[\s\S]*?"problem"[\s\S]*?"watch"[\s\S]*?\}\s*/m, '')
      .replace(/^\s*~{2,}\s*/gm, '')
      .trim();
    responseEl.innerHTML = '<div class="ai-label">FULL ANALYSIS</div><div class="ai-body"></div>';
    streamToElement(responseEl.querySelector('.ai-body'), cleanResult);

    await saveAnalysis('CSV Session Analysis', result, `${parsedData.length} shots Â· ${parsedFilename}`, 'upload', parsedData.slice(0, 50), notes);
    await loadHistory();
  } catch(e) {
    responseEl.innerHTML = `<div style="color:#ff8080">âš ï¸ ${e.message || 'Error connecting. Check your setup.'}</div>`;
  }

  btn.disabled = false; btn.textContent = 'ğŸ¤– Analyze Again';
}

// â”€â”€â”€ SHOT ANALYZER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateShotViz() {
  const path = parseFloat(document.getElementById('a-path').value) || 0;
  const face = parseFloat(document.getElementById('a-face').value) || 0;
  const curvature = (face - path) * 6;
  const startDir = (face * 0.75 + path * 0.25) * 5;
  const endX = 110 + startDir + curvature;
  const controlX = 110 + startDir + curvature * 0.3;
  const svgPath = document.getElementById('shot-svg-path');
  svgPath.setAttribute('d', `M110,110 Q${controlX},60 ${endX},15`);
  if (curvature > 5) svgPath.setAttribute('stroke', '#e63946');
  else if (curvature < -5) svgPath.setAttribute('stroke', '#52b788');
  else svgPath.setAttribute('stroke', '#ffd166');
}

['a-path', 'a-face'].forEach(id => {
  document.getElementById(id)?.addEventListener('input', updateShotViz);
});

async function runShotAnalysis() {
  const btn = document.getElementById('shot-btn');
  const club = document.getElementById('a-club').value;
  const shape = document.getElementById('a-shape').value;
  const path = document.getElementById('a-path').value;
  const face = document.getElementById('a-face').value;
  const attack = document.getElementById('a-attack').value;
  const spin = document.getElementById('a-spin').value;
  const spinAxis = document.getElementById('a-spinaxis').value;
  const ballspeed = document.getElementById('a-ballspeed').value;
  const clubspeed = document.getElementById('a-clubspeed').value;
  const handicap = userProfile.handicap || '15-24';

  const responseEl = document.getElementById('shot-analysis');
  responseEl.className = 'ai-response visible';
  responseEl.innerHTML = '<div class="ai-label">CADDIE IQ DIAGNOSING</div><div class="loading"><div class="spinner"></div>Analyzing your ball flight...</div>';
  btn.disabled = true;

  const smash = ballspeed && clubspeed ? (parseFloat(ballspeed)/parseFloat(clubspeed)).toFixed(2) : 'N/A';

  const prompt = `Diagnose this ${club} shot for a ${handicap} handicap golfer who wants to hit a ${shape}:

Club Path: ${path || 'not provided'}Â°
Face Angle: ${face || 'not provided'}Â°
Attack Angle: ${attack || 'not provided'}Â°
Spin Rate: ${spin || 'not provided'} rpm
Spin Axis: ${spinAxis || 'not provided'}Â°
Ball Speed: ${ballspeed || 'not provided'} mph
Club Speed: ${clubspeed || 'not provided'} mph
Smash Factor: ${smash}

Please provide two sections:

PLAIN_ENGLISH_JSON (output this exact JSON first, no markdown):
{"problem":"one sentence plain English what is causing their shot shape issue","fix":"one simple feel cue they can try immediately on the range","watch":"the single most important number to change and the target value"}

Then the full diagnosis:
1. **What Your Ball Is Doing** â€” Describe the actual shot shape and why.
2. **Why You're Not Hitting a ${shape}** â€” Specific numbers causing the issue.
3. **Exact Changes Needed** â€” What numbers need to change and by how much?
4. **Feel Cues** â€” 2 feel-based tips a golfer can use on the range.
5. **Contact Quality** â€” Is their smash factor of ${smash} good for a ${club}?`;

  try {
    const result = await askClaude(prompt);

    // Extract plain english JSON
    let peShotData = null;
    try {
      const codeMatch = result.match(/```json\s*([\s\S]*?)```/);
      if (codeMatch) peShotData = JSON.parse(codeMatch[1].trim());
    } catch(e) {}
    if (!peShotData) {
      try {
        const rawMatch = result.match(/\{[\s\S]*?"problem"[\s\S]*?"fix"[\s\S]*?"watch"[\s\S]*?\}/);
        if (rawMatch) peShotData = JSON.parse(rawMatch[0]);
      } catch(e) {}
    }
    if (peShotData) {
      document.getElementById('pe-problem-shot').textContent = peShotData.problem || 'â€”';
      document.getElementById('pe-fix-shot').textContent = peShotData.fix || 'â€”';
      document.getElementById('pe-watch-shot').textContent = peShotData.watch || 'â€”';
      document.getElementById('pe-card-shot').style.display = 'block';
    }

    let cleanResult = result
      .replace(/PLAIN_ENGLISH_JSON[\s\S]*?```json[\s\S]*?```/, '')
      .replace(/```json[\s\S]*?```/g, '')
      .replace(/PLAIN_ENGLISH_JSON/g, '')
      .replace(/^\s*\{[\s\S]*?"problem"[\s\S]*?"watch"[\s\S]*?\}\s*/m, '')
      .trim();
    responseEl.innerHTML = '<div class="ai-label">DIAGNOSIS COMPLETE</div><div class="ai-body"></div>';
    streamToElement(responseEl.querySelector('.ai-body'), cleanResult);
    updateShotViz();

    await saveAnalysis(`${club} Shot Analysis`, result, `Goal: ${shape} Â· HC: ${handicap}`, 'shot_analyzer');
    await loadHistory();
  } catch(e) {
    responseEl.innerHTML = `<div style="color:#ff8080">âš ï¸ ${e.message || 'Error. Check setup.'}</div>`;
  }

  btn.disabled = false;
}

// â”€â”€â”€ ROADMAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ROADMAP_DATA = {
  '25+': {
    title: 'Beginner Focus Areas',
    desc: 'At this stage, fundamentals create the biggest improvement. Focus on these first:',
    metrics: [
      { priority: 'PRIORITY #1', name: 'Smash Factor', label: 'Contact Quality', desc: 'Getting the ball off center face matters more than anything. Target 1.40+ for irons.' },
      { priority: 'PRIORITY #2', name: 'Face Angle', label: 'Starting Direction', desc: 'Face angle determines ~75% of where the ball starts. Square it up before worrying about path.' },
      { priority: 'PRIORITY #3', name: 'Launch Angle', label: 'Getting Airborne', desc: 'Too low = topped shots, too high = fat shots. Ideal 7 iron: 16â€“20Â°.' }
    ]
  },
  '15-24': {
    title: 'Mid Handicap Focus Areas',
    desc: "You're making decent contact â€” now shape the ball and build consistency:",
    metrics: [
      { priority: 'PRIORITY #1', name: 'Club Path vs Face Angle', label: 'D-Plane Gap', desc: 'Face-to-path gap creates curve. For a draw: close face relative to path (face left of path for right-handers).' },
      { priority: 'PRIORITY #2', name: 'Club Path', label: 'Swing Direction', desc: 'Out-to-in path causes pulls and fades. Work toward neutral (0Â°) or slightly positive (+2 to +4Â°).' },
      { priority: 'PRIORITY #3', name: 'Spin Rate Variance', label: 'Strike Consistency', desc: 'Variance of Â±1000+ rpm signals inconsistent strike location. Consistent spin = consistent distance.' },
      { priority: 'BONUS', name: 'Attack Angle', label: 'Ball-First Contact', desc: 'Steeper attack (-5Â° to -6Â°) for irons = better compression. Too shallow leads to thin shots.' }
    ]
  },
  '5-14': {
    title: 'Low-Mid Handicap Focus Areas',
    desc: 'You have the basics â€” now precision and shot shaping define your scoring:',
    metrics: [
      { priority: 'PRIORITY #1', name: 'Face-to-Path Relationship', label: 'Shot Shape Control', desc: 'Hit both draw and fade on demand. A gap of 2â€“5Â° creates a gentle curve. Over 8Â° is a big miss.' },
      { priority: 'PRIORITY #2', name: 'Dynamic Loft', label: 'Compression', desc: 'Forward shaft lean increases compression and distance. Target 3â€“5Â° forward lean for irons.' },
      { priority: 'PRIORITY #3', name: 'Spin Axis Variance', label: 'Dispersion Control', desc: 'Keep spin axis within Â±5Â° for controlled dispersion that holds greens.' }
    ]
  },
  '0-4': {
    title: 'Scratch-Level Focus Areas',
    desc: "At this level you're optimizing. Small gains in each metric compound into birdies:",
    metrics: [
      { priority: 'PRIORITY #1', name: 'Face Closure Rate', label: 'Dynamic Face Control', desc: 'How fast the face closes through impact. Controlling this is the difference between a draw and a hook under pressure.' },
      { priority: 'PRIORITY #2', name: 'Low Point Control', label: 'Turf Interaction', desc: 'Where the club bottoms out relative to the ball. 1 inch forward = +10 yards with irons.' },
      { priority: 'PRIORITY #3', name: 'Vertical Gear Effect', label: 'Spin Optimization', desc: 'Hitting above center on driver reduces spin ~400rpm = more distance.' }
    ]
  }
};

function selectHandicap(el, val) {
  document.querySelectorAll('.hc-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  renderRoadmap(val);
}

function renderRoadmap(hc) {
  const data = ROADMAP_DATA[hc] || ROADMAP_DATA['15-24'];
  let html = `<div class="card"><div class="card-title">ğŸ“ ${data.title}</div><p style="font-size:0.88rem; color:var(--mid); margin-bottom:1.5rem;">${data.desc}</p><div class="metrics-grid">`;
  data.metrics.forEach(m => {
    html += `<div class="metric-pill"><div class="mp-label">${m.label}</div><div class="mp-name">${m.name}</div><div class="mp-desc">${m.desc}</div><div class="mp-priority">${m.priority}</div></div>`;
  });
  html += '</div></div>';
  document.getElementById('roadmap-content').innerHTML = html;
}

async function getRoadmapAdvice() {
  const q = document.getElementById('roadmap-question').value.trim();
  if (!q) return;

  const handicap = userProfile.handicap || '15-24';
  const responseEl = document.getElementById('roadmap-advice');
  responseEl.className = 'ai-response visible';
  responseEl.innerHTML = '<div class="ai-label">CADDIE IQ RESPONDING</div><div class="loading"><div class="spinner"></div>Thinking...</div>';

  const prompt = `You are an expert golf coach. A ${handicap} handicap golfer asks: "${q}"

Give practical, specific advice for their skill level. Reference Trackman metrics where relevant.
Include: 1. Root cause diagnosis. 2. 2â€“3 specific drills or swing changes. 3. Target Trackman numbers.
Keep it conversational and encouraging.`;

  try {
    const result = await askClaude(prompt);
    responseEl.innerHTML = '<div class="ai-label">CADDIE IQ ADVICE</div><div class="ai-body"></div>';
    streamToElement(responseEl.querySelector('.ai-body'), result);

    await saveAnalysis('Improvement Question', result, q.substring(0, 80), 'roadmap');
    await loadHistory();
  } catch(e) {
    responseEl.innerHTML = `<div style="color:#ff8080">âš ï¸ ${e.message}</div>`;
  }
}

// â”€â”€â”€ DATABASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveAnalysis(title, content, subtitle, sessionType, rawData, notes) {
  if (!currentUser) return;

  await db.from('analyses').insert({
    user_id: currentUser.id,
    title,
    subtitle: subtitle || '',
    content,
    session_type: sessionType || 'manual',
    raw_data: rawData || null,
    handicap_at_time: userProfile.handicap,
    session_notes: notes || ''
  });
}

async function loadHistory() {
  if (!currentUser) return;

  const { data, error } = await db
    .from('analyses')
    .select('*')
    .eq('user_id', currentUser.id)
    .order('created_at', { ascending: false })
    .limit(50);

  if (error) { console.error(error); return; }

  const sessions = data || [];

  // Update stats
  document.getElementById('stat-sessions').textContent = sessions.filter(s => s.session_type === 'upload').length;
  document.getElementById('stat-analyses').textContent = sessions.length;

  renderHistory(sessions);
  renderRecentAnalyses(sessions);
}

function renderHistory(sessions) {
  const container = document.getElementById('history-list');
  if (!sessions || !sessions.length) {
    container.innerHTML = '<div class="empty-state"><div class="es-icon">ğŸ“‚</div><p>No history yet. Start by uploading data or running a shot analysis.</p></div>';
    return;
  }
  let html = '';
  sessions.forEach(s => {
    const date = new Date(s.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    const time = new Date(s.created_at).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    const preview = s.content.replace(/\*\*/g, '').substring(0, 120) + '...';
    html += `
      <div class="history-item" onclick="viewAnalysis(${JSON.stringify(s).replace(/"/g, '&quot;')})">
        <div class="hi-date">${date} Â· ${time} Â· ${s.handicap_at_time || 'â€”'} HCP</div>
        <div class="hi-title">${s.title}</div>
        <div style="font-size:0.78rem; color:var(--green); margin-bottom:0.3rem;">${s.subtitle || ''}</div>
        <div class="hi-preview">${preview}</div>
      </div>`;
  });
  container.innerHTML = html;
}

function renderRecentAnalyses(sessions) {
  const container = document.getElementById('recent-analyses-wrap');
  if (!sessions || !sessions.length) {
    container.innerHTML = `
      <div class="card-title" style="font-family:'Bebas Neue'; font-size:1.1rem; letter-spacing:1px; color:var(--green); margin-bottom:1rem;">ğŸ“‹ Recent Analyses</div>
      <div class="empty-state"><div class="es-icon">ğŸŒï¸</div><p>No analyses yet.</p><br>
      <button class="btn btn-primary" onclick="showPanel('upload')">Upload Data â†’</button></div>`;
    return;
  }
  let html = '<div class="card-title" style="font-family:\'Bebas Neue\'; font-size:1.1rem; letter-spacing:1px; color:var(--green); margin-bottom:1rem;">ğŸ“‹ Recent Analyses</div>';
  sessions.slice(0, 3).forEach(s => {
    const date = new Date(s.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    html += `
      <div class="history-item" onclick="viewAnalysis(${JSON.stringify(s).replace(/"/g, '&quot;')})">
        <div class="hi-date">${date}</div>
        <div class="hi-title">${s.title}</div>
        <div class="hi-preview">${s.content.replace(/\*\*/g, '').substring(0, 80)}...</div>
      </div>`;
  });
  container.innerHTML = html;
}

function viewAnalysis(s) {
  if (typeof s === 'string') {
    try { s = JSON.parse(s.replace(/&quot;/g, '"')); } catch(e) { return; }
  }
  const date = new Date(s.created_at).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
  const popup = document.createElement('div');
  popup.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:9999; display:flex; align-items:center; justify-content:center; padding:1rem;';
  popup.innerHTML = `
    <div style="background:var(--fairway); border-radius:16px; padding:2rem; max-width:700px; width:100%; max-height:80vh; overflow-y:auto;">
      <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1rem;">
        <div>
          <div style="font-family:'Bebas Neue'; font-size:1.4rem; color:var(--gold-light); letter-spacing:1px;">${s.title}</div>
          <div style="font-size:0.78rem; color:var(--green-light); font-family:'DM Mono';">${date}</div>
        </div>
        <button onclick="this.closest('[style]').remove()" style="background:rgba(255,255,255,0.1); border:none; color:white; width:32px; height:32px; border-radius:50%; cursor:pointer; font-size:1rem;">âœ•</button>
      </div>
      <div style="font-size:0.9rem; line-height:1.75; color:rgba(255,255,255,0.88); white-space:pre-wrap;">
        ${s.content.replace(/\*\*(.*?)\*\*/g, '<strong style="color:var(--gold-light)">$1</strong>')}
      </div>
    </div>`;
  document.body.appendChild(popup);
  popup.addEventListener('click', (e) => { if (e.target === popup) popup.remove(); });
}

async function exportHistory() {
  if (!currentUser) return;
  const { data } = await db.from('analyses').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false });
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `caddieiq-history-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
}

async function clearHistory() {
  if (!currentUser || !confirm('Delete all your history? This cannot be undone.')) return;
  await db.from('analyses').delete().eq('user_id', currentUser.id);
  await loadHistory();
}


// â”€â”€ WORK ON TODAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function getWorkOnToday() {
  const resultEl = document.getElementById('wot-result');
  const bodyEl = document.getElementById('wot-body');
  resultEl.classList.add('visible');
  bodyEl.innerHTML = '<div class="loading"><div class="spinner"></div>Looking at your recent sessions...</div>';

  const { data: recent } = await db
    .from('analyses')
    .select('content, created_at, handicap_at_time, session_notes')
    .eq('user_id', currentUser.id)
    .order('created_at', { ascending: false })
    .limit(5);

  const handicap = userProfile.handicap || '15-24';
  const goal = userProfile.goal || 'draw';

  let sessionSummary = 'No previous sessions yet.';
  if (recent && recent.length) {
    sessionSummary = recent.map((s, i) => {
      const d = new Date(s.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      const preview = s.content.replace(/\*\*/g, '').substring(0, 300);
      const notes = s.session_notes ? `\nGolfer notes: "${s.session_notes}"` : '';
      return `Session ${i+1} (${d}): ${preview}${notes}`;
    }).join('\n\n');
  }

  const prompt = `You are a golf coach reviewing a ${handicap} handicap golfer's recent Trackman sessions. Their goal is to hit a ${goal}.

Recent sessions:
${sessionSummary}

Give them a focused, specific practice plan for TODAY's range session. Be direct and motivating. Format as:

**Today's Focus:** [one specific thing â€” e.g. "Club Path â€” getting it from -3.5Â° to neutral"]

**Why This:** [one sentence connecting it to their recent data]

**The Drill:** [one specific drill with clear instructions â€” reps, setup, what to feel]

**Success Looks Like:** [what number or feel tells them it's working]

**Time Split:** [e.g. 30 balls on this, 15 balls playing shots]

Keep it tight â€” this should feel like a note from their caddie before a practice session, not a lecture.`;

  try {
    const result = await askClaude(prompt);
    bodyEl.innerHTML = '';
    streamToElement(bodyEl, result);
  } catch(e) {
    bodyEl.innerHTML = '<span style="color:#ff8080">âš ï¸ Could not load recommendation. Try again.</span>';
  }
}

// â”€â”€ PROGRESS SNAPSHOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function buildProgressSnapshot() {
  if (!currentUser) return;

  const { data } = await db
    .from('analyses')
    .select('content, created_at')
    .eq('user_id', currentUser.id)
    .eq('session_type', 'upload')
    .order('created_at', { ascending: true });

  if (!data || data.length < 2) return; // Need at least 2 sessions

  // Extract numeric metrics from analysis text
  function extractMetric(text, pattern) {
    const match = text.match(pattern);
    return match ? parseFloat(match[1]) : null;
  }

  const first = data[0].content;
  const last = data[data.length - 1].content;

  const metrics = [
    {
      name: 'Club Path',
      unit: 'Â°',
      first: extractMetric(first, /club path[^:]*:\s*([-+]?\d+\.?\d*)/i),
      last: extractMetric(last, /club path[^:]*:\s*([-+]?\d+\.?\d*)/i),
      betterDirection: 'toward-zero', // closer to 0 is better
      target: '0Â°'
    },
    {
      name: 'Face Angle',
      unit: 'Â°',
      first: extractMetric(first, /face angle[^:]*:\s*([-+]?\d+\.?\d*)/i),
      last: extractMetric(last, /face angle[^:]*:\s*([-+]?\d+\.?\d*)/i),
      betterDirection: 'toward-zero',
      target: '0Â°'
    },
    {
      name: 'Smash Factor',
      unit: '',
      first: extractMetric(first, /smash factor[^:]*:\s*(\d+\.?\d*)/i),
      last: extractMetric(last, /smash factor[^:]*:\s*(\d+\.?\d*)/i),
      betterDirection: 'higher',
      target: '1.45'
    }
  ].filter(m => m.first !== null && m.last !== null && m.first !== m.last);

  if (!metrics.length) return;

  const firstDate = new Date(data[0].created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  const lastDate = new Date(data[data.length-1].created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

  let html = '';
  metrics.forEach(m => {
    let trend = 'neutral';
    let trendLabel = 'No change';

    if (m.betterDirection === 'toward-zero') {
      const firstAbs = Math.abs(m.first);
      const lastAbs = Math.abs(m.last);
      if (lastAbs < firstAbs) { trend = 'better'; trendLabel = 'âœ“ Improving'; }
      else if (lastAbs > firstAbs) { trend = 'worse'; trendLabel = 'Needs work'; }
    } else if (m.betterDirection === 'higher') {
      if (m.last > m.first) { trend = 'better'; trendLabel = 'âœ“ Improving'; }
      else if (m.last < m.first) { trend = 'worse'; trendLabel = 'Needs work'; }
    }

    html += `
      <div class="ps-metric">
        <div class="ps-metric-name">${m.name}</div>
        <div class="ps-metric-values">
          <div class="ps-old">${m.first}${m.unit}</div>
          <div class="ps-arrow-icon">â†’</div>
          <div class="ps-new">${m.last}${m.unit}</div>
        </div>
        <div class="ps-trend ${trend}">${trendLabel}</div>
      </div>`;
  });

  document.getElementById('ps-metrics-grid').innerHTML = html;
  document.getElementById('ps-caption').textContent =
    `Based on ${data.length} sessions Â· ${firstDate} â†’ ${lastDate} Â· Target: neutral numbers`;
  document.getElementById('progress-snapshot').style.display = 'block';
}


// â”€â”€â”€ VISUAL DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function toggleFullAnalysis(btn) {
  btn.classList.toggle('open');
  btn.nextElementSibling.classList.toggle('open');
  const span = btn.querySelector('span:first-child');
  span.textContent = btn.classList.contains('open') ? 'ğŸ“„ Hide Full Analysis' : 'ğŸ“„ Read Full Analysis';
}

// Extract average value from parsed CSV data for a given column name
function getAvgMetric(data, ...keys) {
  // Try exact keys first, then case-insensitive match
  for (const key of keys) {
    const vals = data.map(r => parseFloat(r[key])).filter(v => !isNaN(v));
    if (vals.length) return vals.reduce((a, b) => a + b, 0) / vals.length;
  }
  // Fallback: case-insensitive partial match on any column
  for (const key of keys) {
    const lk = key.toLowerCase().replace(/[^a-z]/g, '');
    const allKeys = data.length ? Object.keys(data[0]) : [];
    const match = allKeys.find(k => k.toLowerCase().replace(/[^a-z]/g, '') === lk);
    if (match) {
      const vals = data.map(r => parseFloat(r[match])).filter(v => !isNaN(v));
      if (vals.length) return vals.reduce((a, b) => a + b, 0) / vals.length;
    }
  }
  return null;
}

function buildVisualDashboard(data, handicap, goal) {
  const dashboard = document.getElementById('visual-dashboard');
  dashboard.classList.add('visible');
  document.getElementById('full-analysis-wrap').style.display = 'block';

  // Extract averages from CSV
  const clubPath  = getAvgMetric(data, 'Club Path', 'Club Path (Â°)', 'club_path', 'ClubPath', 'clubpath');
  const faceAngle = getAvgMetric(data, 'Face Angle', 'Face Angle (Â°)', 'face_angle', 'FaceAngle', 'faceangle');
  const f2p       = clubPath !== null && faceAngle !== null ? faceAngle - clubPath : null;
  const smash     = getAvgMetric(data, 'Smash Factor', 'smash_factor', 'SmashFactor', 'smashfactor');
  const attackAng = getAvgMetric(data, 'Attack Angle', 'Attack Angle (Â°)', 'attack_angle', 'AttackAngle', 'attackangle');
  const spinAxis  = getAvgMetric(data, 'Spin Axis', 'Spin Axis (Â°)', 'spin_axis', 'SpinAxis', 'spinaxis');

  // Debug: log what we found
  console.log('Caddie IQ metrics:', { clubPath, faceAngle, f2p, smash, attackAng, spinAxis });
  console.log('CSV columns:', data.length ? Object.keys(data[0]) : 'no data');

  // Build gauges
  buildGauges({ clubPath, faceAngle, f2p, smash, attackAng }, handicap, goal);

  // Build path diagram
  buildPathDiagram(clubPath, goal);

  // Build drill cards
  buildDrillCards(clubPath, faceAngle, f2p, smash, handicap, goal);

  // Build grip cards
  buildGripCards(faceAngle, spinAxis, goal);
}

// â”€â”€ GAUGE BUILDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildGauges(metrics, handicap, goal) {
  const isDrawGoal = goal === 'draw';

  const gaugeSpecs = [
    {
      name: 'Club Path',
      unit: 'Â°',
      value: metrics.clubPath,
      min: -12, max: 12,
      targetMin: isDrawGoal ? 0 : -4,
      targetMax: isDrawGoal ? 4 : 0,
      targetLabel: isDrawGoal ? '0Â° to +4Â°' : '-4Â° to 0Â°',
      goodMsg: 'âœ“ In the draw zone',
      badMsg: (v) => v < 0 ? `${Math.abs(v).toFixed(1)}Â° too far left` : `${v.toFixed(1)}Â° too far right`
    },
    {
      name: 'Face Angle',
      unit: 'Â°',
      value: metrics.faceAngle,
      min: -8, max: 8,
      targetMin: -1,
      targetMax: 1,
      targetLabel: '-1Â° to +1Â°',
      goodMsg: 'âœ“ Square at impact',
      badMsg: (v) => v > 0 ? `${v.toFixed(1)}Â° open â€” ball starts right` : `${Math.abs(v).toFixed(1)}Â° closed â€” ball starts left`
    },
    {
      name: 'Face to Path',
      unit: 'Â°',
      value: metrics.f2p,
      min: -12, max: 12,
      targetMin: isDrawGoal ? -5 : 0,
      targetMax: isDrawGoal ? -1 : 5,
      targetLabel: isDrawGoal ? '-5Â° to -1Â°' : '+1Â° to +5Â°',
      goodMsg: isDrawGoal ? 'âœ“ Producing draw spin' : 'âœ“ Producing fade spin',
      badMsg: (v) => v > 0 ? `Too open â€” fade/slice spin` : `Too closed â€” draw/hook spin`
    },
    {
      name: 'Smash Factor',
      unit: '',
      value: metrics.smash,
      min: 1.2, max: 1.5,
      targetMin: 1.40,
      targetMax: 1.48,
      targetLabel: '1.40 â€“ 1.48',
      goodMsg: 'âœ“ Solid contact',
      badMsg: (v) => v < 1.40 ? 'Off-center contact â€” work on strike' : 'Check your numbers'
    },
    {
      name: 'Attack Angle',
      unit: 'Â°',
      value: metrics.attackAng,
      min: -10, max: 2,
      targetMin: -6,
      targetMax: -3,
      targetLabel: '-6Â° to -3Â°',
      goodMsg: 'âœ“ Good descending blow',
      badMsg: (v) => v > -3 ? 'Too shallow â€” try to hit down more' : 'Very steep â€” soften the angle'
    }
  ].filter(g => g.value !== null);

  const grid = document.getElementById('gauge-grid');
  grid.innerHTML = '';

  gaugeSpecs.forEach(spec => {
    const val = parseFloat(spec.value.toFixed(2));
    const inRange = val >= spec.targetMin && val <= spec.targetMax;
    const close = val >= spec.targetMin - 2 && val <= spec.targetMax + 2;
    const colorClass = inRange ? 'green' : close ? 'yellow' : 'red';
    const statusMsg = inRange ? spec.goodMsg : spec.badMsg(val);

    // Calculate marker position (0â€“100%)
    const range = spec.max - spec.min;
    const markerPct = Math.max(2, Math.min(98, ((val - spec.min) / range) * 100));
    const rangeLeftPct = ((spec.targetMin - spec.min) / range) * 100;
    const rangeWidthPct = ((spec.targetMax - spec.targetMin) / range) * 100;

    const card = document.createElement('div');
    card.className = `gauge-card ${colorClass}`;
    card.innerHTML = `
      <div class="gauge-metric-name">${spec.name}</div>
      <div class="gauge-values">
        <div class="gauge-actual">${val > 0 ? '+' : ''}${val}</div>
        <div class="gauge-unit">${spec.unit}</div>
        <div class="gauge-target-label">Target: ${spec.targetLabel}</div>
      </div>
      <div class="gauge-bar-track">
        <div class="gauge-bar-range" style="left:${rangeLeftPct}%; width:${rangeWidthPct}%"></div>
        <div class="gauge-bar-marker" style="left:${markerPct}%"></div>
      </div>
      <div class="gauge-status">${statusMsg}</div>
    `;
    grid.appendChild(card);
  });
}

// â”€â”€ PATH SPECTRUM SLIDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPathDiagram(clubPath, goal) {
  if (clubPath === null) return;

  const isDrawGoal = goal === 'draw';
  const val = parseFloat(clubPath.toFixed(1));

  // Scale: -10 to +10 degrees maps to 0-100%
  const SCALE_MIN = -10, SCALE_MAX = 10;
  function toPercent(deg) {
    return Math.max(1, Math.min(99, ((deg - SCALE_MIN) / (SCALE_MAX - SCALE_MIN)) * 100));
  }

  // Position the marker
  const markerPct = toPercent(val);
  const marker = document.getElementById('path-marker');
  const markerLabel = document.getElementById('path-marker-label');
  if (marker) {
    marker.style.left = markerPct + '%';
    markerLabel.textContent = (val > 0 ? '+' : '') + val + 'Â°';
  }

  // Draw target zone
  const targetMin = isDrawGoal ? 0 : -4;
  const targetMax = isDrawGoal ? 4 : 0;
  const zone = document.getElementById('path-target-zone');
  if (zone) {
    zone.style.left = toPercent(targetMin) + '%';
    zone.style.width = (toPercent(targetMax) - toPercent(targetMin)) + '%';
  }

  // Direction labels
  const direction = val < -1 ? 'Out-to-In (fade/slice path)'
                  : val > 1  ? 'In-to-Out (draw path)'
                  : 'Neutral';
  const inRange = val >= targetMin && val <= targetMax;

  const valueEl = document.getElementById('path-value-display');
  const descEl  = document.getElementById('path-desc-display');
  const targetEl = document.getElementById('path-target-display');
  const targetDescEl = document.getElementById('path-target-desc');

  if (valueEl) valueEl.textContent = (val > 0 ? '+' : '') + val + 'Â°';
  if (descEl)  descEl.textContent  = direction;
  if (targetEl) targetEl.textContent = isDrawGoal ? '0Â° to +4Â°' : '-4Â° to 0Â°';
  if (targetDescEl) targetDescEl.textContent = inRange
    ? `You're in the ideal zone for a ${goal} âœ“`
    : `Shift your path ${val < targetMin ? 'more in-to-out' : 'more out-to-in'} by ~${Math.abs(val - (isDrawGoal ? 2 : -2)).toFixed(1)}Â°`;
}

// â”€â”€ DRILL CARD BUILDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildDrillCards(clubPath, faceAngle, f2p, smash, handicap, goal) {
  const drills = [];
  const isDrawGoal = goal === 'draw';

  if (clubPath !== null && clubPath < -1) {
    drills.push({
      badge: 'PATH',
      name: 'Alignment Stick Drill',
      steps: [
        'Place an alignment stick in the ground just outside the ball, angled toward your target.',
        "On your downswing, feel like you're swinging the club under and past the stick.",
        'Hit 20 balls focusing on the club traveling from inside to outside the target line.'
      ],
      feel: "Feel like you're swinging out to right field (for right-handers) â€” more than you think you need to.",
    });
  }

  if (faceAngle !== null && faceAngle > 1) {
    drills.push({
      badge: 'FACE',
      name: 'Towel Under Lead Arm',
      steps: [
        'Tuck a small towel under your lead armpit (left arm for right-handers).',
        'Make swings keeping the towel in place through impact.',
        'This promotes body rotation which closes the face naturally.'
      ],
      feel: 'Feel the face rotate to point at the ground just after impact â€” like closing a door.'
    });
  }

  if (smash !== null && smash < 1.40) {
    drills.push({
      badge: 'CONTACT',
      name: 'Tee Strike Drill',
      steps: [
        'Push a tee into the ground just forward of center in your stance.',
        'Hit shots trying to clip the tee after the ball.',
        "If you hit the tee before the ball, you're hitting behind it â€” adjust forward.",
      ],
      feel: "Hear a crisp click on the ball then see the tee fly forward â€” that's a centered strike.",
    });
  }

  if (!drills.length) {
    drills.push({
      badge: 'CONSISTENCY',
      name: 'Tempo Drill â€” 3:1 Ratio',
      steps: [
        'Count "1-2-3" on your backswing, "1" on your downswing.',
        'Hit 15 balls with this slow tempo, focusing on smooth transition.',
        'Gradually speed up while keeping the same ratio.'
      ],
      feel: "The downswing should feel almost passive â€” let the club fall, don't force it.",
    });
  }

  const grid = document.getElementById('drill-cards-grid');
  grid.innerHTML = drills.map(d => `
    <div class="drill-card">
      <div class="drill-card-header">
        <div class="drill-badge">${d.badge}</div>
        <div class="drill-name">${d.name}</div>
      </div>
      <div class="drill-steps">
        ${d.steps.map((s, i) => `
          <div class="drill-step">
            <div class="drill-step-num">${i + 1}</div>
            <div>${s}</div>
          </div>`).join('')}
      </div>
      <div class="drill-feel-cue">
        <strong>Feel Cue</strong>
        ${d.feel}
      </div>
    </div>
  `).join('');
}

// â”€â”€ GRIP BUILDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildGripCards(faceAngle, spinAxis, goal) {
  let recommended = "neutral";
  if (faceAngle !== null) {
    if (faceAngle > 2) recommended = "strong";
    else if (faceAngle < -2) recommended = "weak";
    else if (goal === "draw") recommended = "strong";
    else if (goal === "fade") recommended = "neutral";
  } else if (goal === "draw") recommended = "strong";

  const grips = [
    { type: "strong", name: "Strong Grip", desc: "2-3 knuckles visible. Closes face naturally â€” good for drawing.", knuckles: 3, vDir: "Right shoulder", color: "#2d6a4f" },
    { type: "neutral", name: "Neutral Grip", desc: "2 knuckles visible. Square face at impact â€” the standard.", knuckles: 2, vDir: "Chin", color: "#4a4a6a" },
    { type: "weak", name: "Weak Grip", desc: "1 knuckle visible. Opens face naturally â€” good for fading.", knuckles: 1, vDir: "Left shoulder", color: "#457b9d" }
  ];

  const container = document.getElementById("grip-cards");
  container.innerHTML = grips.map(g => `
    <div class="grip-card ${g.type === recommended ? "highlighted" : ""}">
      ${buildRealisticGripSVG(g.type, g.knuckles, g.color)}
      <div class="grip-card-name">${g.name}</div>
      <div class="grip-card-desc">${g.desc}</div>
      <div style="font-size:0.7rem;color:var(--muted);margin-top:0.3rem;">V â†’ <strong>${g.vDir}</strong></div>
      <div class="grip-recommended">â˜… Recommended for you</div>
    </div>
  `).join("");
}

function buildRealisticGripSVG(type, knuckles, color) {
  const handRotate = type === "strong" ? 18 : type === "weak" ? -18 : 0;
  const skin = "#e8c49a", skinDark = "#d4a876", skinShadow = "#c49060";
  const kx = type === "strong" ? [22,31,40,49] : type === "weak" ? [30,39,48,57] : [26,35,44,53];
  const dots = Array.from({length: knuckles}, (_,i) =>
    `<circle cx="${kx[i]}" cy="36" r="3.5" fill="${skinDark}" stroke="${skinShadow}" stroke-width="0.5"/>`
  ).join("");
  const thumbCx = type === "strong" ? 58 : type === "weak" ? 32 : 58;
  const thumbRot = type === "strong" ? -25 : type === "weak" ? 25 : -20;

  return `<svg width="90" height="112" viewBox="0 0 90 112" style="margin:0 auto 0.5rem;display:block;">
    <rect x="41" y="0" width="8" height="75" rx="4" fill="#c9a96e"/>
    <rect x="42" y="0" width="3" height="75" rx="2" fill="#dfc080" opacity="0.5"/>
    <g transform="rotate(${handRotate},45,60)">
      <ellipse cx="45" cy="68" rx="22" ry="18" fill="${skin}"/>
      <ellipse cx="45" cy="72" rx="20" ry="12" fill="${skinDark}" opacity="0.3"/>
      <rect x="18" y="36" width="10" height="26" rx="5" fill="${skin}" stroke="${skinDark}" stroke-width="0.5"/>
      <rect x="29" y="30" width="10" height="30" rx="5" fill="${skin}" stroke="${skinDark}" stroke-width="0.5"/>
      <rect x="40" y="30" width="10" height="30" rx="5" fill="${skin}" stroke="${skinDark}" stroke-width="0.5"/>
      <rect x="51" y="33" width="10" height="27" rx="5" fill="${skin}" stroke="${skinDark}" stroke-width="0.5"/>
      <rect x="20" y="38" width="4" height="10" rx="2" fill="rgba(255,255,255,0.35)"/>
      <rect x="31" y="32" width="4" height="10" rx="2" fill="rgba(255,255,255,0.35)"/>
      <rect x="42" y="32" width="4" height="10" rx="2" fill="rgba(255,255,255,0.35)"/>
      <rect x="53" y="35" width="4" height="10" rx="2" fill="rgba(255,255,255,0.35)"/>
      ${dots}
      <ellipse cx="${thumbCx}" cy="52" rx="7" ry="10"
        transform="rotate(${thumbRot},${thumbCx},52)"
        fill="${skin}" stroke="${skinDark}" stroke-width="0.5"/>
      <path d="M38,55 Q45,52 52,55" stroke="${skinShadow}" stroke-width="1" fill="none" opacity="0.6"/>
    </g>
    <text x="45" y="102" text-anchor="middle" font-size="9" fill="${color}" font-family="DM Mono" font-weight="bold">${knuckles} KNUCKLE${knuckles !== 1 ? "S" : ""} VISIBLE</text>
    <text x="45" y="112" text-anchor="middle" font-size="7.5" fill="#9090aa" font-family="DM Sans">${type.toUpperCase()} GRIP</text>
  </svg>`;
}

initAuth();
</script>
</body>
</html>
